name: Build Brave Browser (16-Stage - All Platforms)

on:
  workflow_dispatch:
    inputs:
      build_linux_x64:
        description: 'Build Linux x64'
        required: true
        type: boolean
        default: true
      build_linux_arm64:
        description: 'Build Linux arm64'
        required: true
        type: boolean
        default: false
      build_macos_x64:
        description: 'Build macOS x64'
        required: true
        type: boolean
        default: true
      build_macos_arm64:
        description: 'Build macOS arm64'
        required: true
        type: boolean
        default: false
      build_windows_x64:
        description: 'Build Windows x64'
        required: true
        type: boolean
        default: true
      build_windows_arm64:
        description: 'Build Windows arm64'
        required: true
        type: boolean
        default: false
      build_windows_x86:
        description: 'Build Windows x86 (32-bit)'
        required: true
        type: boolean
        default: false
      environment:
        description: 'Deployment environment'
        required: false
        type: environment
      publish_release:
        description: 'Publish GitHub release (uncheck for test builds)'
        required: true
        type: boolean
        default: false
      version_override:
        description: 'Override versions (format: brave_version=v1.85.74;build_system=main) - BLOCKED if ALLOW_PUBLISH_RELEASE=true'
        required: false
        type: string
        default: ''

jobs:
  # ============================================================================
  # Validate Configuration - Runs First, Blocks Invalid Overrides
  # ============================================================================
  
  validate-config:
    name: üîç Validate Configuration
    runs-on: ubuntu-latest
    outputs:
      brave_version: ${{ steps.validate.outputs.brave_version }}
      build_system: ${{ steps.validate.outputs.build_system }}
      patches_public: ${{ steps.validate.outputs.patches_public }}
      patches_private: ${{ steps.validate.outputs.patches_private }}
      allow_publish_release: ${{ steps.validate.outputs.allow_publish_release }}
      environment: ${{ steps.validate.outputs.environment }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Validate version configuration
        id: validate
        env:
          PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
        run: |
          echo "=== Version Configuration Validation ==="
          
          VERSION_OVERRIDE="${{ inputs.version_override }}"
          PUBLISH_REQUESTED="${{ inputs.publish_release }}"
          
          # Derive allow_publish from environment name: 'release' = allowed, anything else = blocked
          if [ "${{ inputs.environment }}" = "release" ]; then
            ALLOW_RELEASE="true"
          else
            ALLOW_RELEASE="false"
          fi
          echo "Environment: ${{ inputs.environment }} ‚Üí allow_publish_release=$ALLOW_RELEASE"
          
          # Block early if publish requested but environment doesn't allow it
          if [ "$PUBLISH_REQUESTED" = "true" ] && [ "$ALLOW_RELEASE" != "true" ]; then
            echo "=========================================="
            echo "FATAL: Release publishing is BLOCKED!"
            echo ""
            echo "publish_release=true was requested, but"
            echo "environment is '${{ inputs.environment }}', not 'release'."
            echo ""
            echo "Select the 'release' environment to publish,"
            echo "or uncheck publish_release for test builds."
            echo "=========================================="
            exit 1
          fi
          
          # Check if override is provided
          if [ -n "$VERSION_OVERRIDE" ]; then
            echo "Version override requested: $VERSION_OVERRIDE"
            echo ""
            
            # Block override if ALLOW_PUBLISH_RELEASE is true
            if [ "$ALLOW_RELEASE" = "true" ]; then
              echo "=========================================="
              echo "FATAL: Version override is BLOCKED!"
              echo ""
              echo "ALLOW_PUBLISH_RELEASE=true means this repository"
              echo "can publish releases. Version overrides are not"
              echo "allowed in release-capable repositories."
              echo ""
              echo "To use version overrides, set ALLOW_PUBLISH_RELEASE"
              echo "to 'false' or remove the variable."
              echo "=========================================="
              exit 1
            fi
            
            echo "‚úì Override allowed (ALLOW_PUBLISH_RELEASE is not 'true')"
            echo ""
            
            # Parse and apply overrides to versions.txt
            cp versions.txt versions.txt.bak
            
            # Valid keys
            VALID_KEYS="brave_version build_system patches_public patches_private"
            
            IFS=';' read -ra OVERRIDES <<< "$VERSION_OVERRIDE"
            for override in "${OVERRIDES[@]}"; do
              [ -z "$override" ] && continue
              
              # Validate format
              if [[ ! "$override" =~ ^[a-z_]+=[a-zA-Z0-9._/-]+$ ]]; then
                echo "=========================================="
                echo "FATAL: Invalid override format: '$override'"
                echo ""
                echo "Expected: key=value (e.g., brave_version=v1.85.74)"
                echo "Valid keys: $VALID_KEYS"
                echo "=========================================="
                exit 1
              fi
              
              key="${override%%=*}"
              value="${override#*=}"
              
              # Check key is valid
              if ! echo "$VALID_KEYS" | grep -qw "$key"; then
                echo "=========================================="
                echo "FATAL: Unknown key: '$key'"
                echo "Valid keys: $VALID_KEYS"
                echo "=========================================="
                exit 1
              fi
              
              # Apply override (replace or add)
              if grep -q "^${key}=" versions.txt; then
                sed -i "s|^${key}=.*|${key}=${value}|" versions.txt
              else
                echo "${key}=${value}" >> versions.txt
              fi
              echo "‚úì Override applied: $key=$value"
            done
            
            echo ""
            echo "‚ö†Ô∏è  WARNING: Using overridden versions (test build only)"
          else
            echo "No version override - using committed versions.txt"
          fi
          
          # Show final versions
          echo ""
          echo "=== Final Version Configuration ==="
          cat versions.txt
          
          # Extract all versions for output (to pass to builder jobs)
          BRAVE_VERSION=$(grep -E "^brave_version=" versions.txt | cut -d'=' -f2 | tr -d ' ')
          BUILD_SYSTEM=$(grep -E "^build_system=" versions.txt | cut -d'=' -f2 | tr -d ' ')
          PATCHES_PUBLIC=$(grep -E "^patches_public=" versions.txt | cut -d'=' -f2 | tr -d ' ')
          PATCHES_PRIVATE=$(grep -E "^patches_private=" versions.txt | cut -d'=' -f2 | tr -d ' ')
          
          # Set defaults if not specified
          [ -z "$BUILD_SYSTEM" ] && BUILD_SYSTEM="main"
          [ -z "$PATCHES_PUBLIC" ] && PATCHES_PUBLIC="main"
          [ -z "$PATCHES_PRIVATE" ] && PATCHES_PRIVATE="main"
          
          echo ""
          echo "=== Freezing commits (resolving refs to SHAs) ==="
          echo "This ensures all stages use the exact same commits even if branches move during the build."
          echo ""
          
          # Helper function to resolve a ref to commit SHA
          # If the ref is already a full SHA (40 hex chars), use it as-is
          # Otherwise, clone the repo (shallow) to get the actual commit SHA
          resolve_ref() {
            local repo_url="$1"
            local ref="$2"
            local repo_name="$3"
            
            # Check if already a commit SHA (40 hex characters)
            if [[ "$ref" =~ ^[0-9a-f]{40}$ ]]; then
              echo "$ref"
              return 0
            fi
            
            # Try git ls-remote first (fast path)
            local sha
            sha=$(git ls-remote "$repo_url" "$ref" 2>/dev/null | head -1 | cut -f1)
            if [ -n "$sha" ]; then
              echo "$sha"
              return 0
            fi
            
            sha=$(git ls-remote "$repo_url" "refs/heads/$ref" 2>/dev/null | head -1 | cut -f1)
            if [ -n "$sha" ]; then
              echo "$sha"
              return 0
            fi
            
            sha=$(git ls-remote "$repo_url" "refs/tags/$ref" 2>/dev/null | head -1 | cut -f1)
            if [ -n "$sha" ]; then
              echo "$sha"
              return 0
            fi
            
            # Fallback: clone the repo to get the SHA (slower but reliable)
            local tmp_dir=$(mktemp -d)
            if git clone --depth=1 --branch "$ref" "$repo_url" "$tmp_dir" 2>/dev/null; then
              sha=$(git -C "$tmp_dir" rev-parse HEAD 2>/dev/null)
              rm -rf "$tmp_dir"
              if [ -n "$sha" ]; then
                echo "$sha"
                return 0
              fi
            fi
            rm -rf "$tmp_dir" 2>/dev/null
            
            # Last resort: return original ref
            echo "$ref"
          }
          
          # Configure git authentication for private repos (same method as actions/checkout)
          OWNER="${{ github.repository_owner }}"
          
          if [ -n "$PRIVATE_REPO_PAT" ]; then
            # Configure git to use PAT for all GitHub HTTPS URLs
            git config --global url."https://x-access-token:${PRIVATE_REPO_PAT}@github.com/".insteadOf "https://github.com/"
            echo "‚úì Git credentials configured for private repos"
          else
            echo "‚ö†Ô∏è  WARNING: PRIVATE_REPO_PAT not set - private repo commits cannot be frozen"
          fi
          
          # Repository URLs (git will automatically add auth via config above)
          BUILD_SYSTEM_URL="https://github.com/${OWNER}/peasant-build-system.git"
          PATCHES_PUBLIC_URL="https://github.com/${OWNER}/peasant-patches-mpl.git"
          PATCHES_PRIVATE_URL="https://github.com/${OWNER}/peasant-patches-private.git"
          
          # Resolve refs to commit SHAs (freeze the commits)
          echo "PAT available: $([ -n "$PRIVATE_REPO_PAT" ] && echo 'yes' || echo 'no')"
          echo ""
          
          echo "Resolving build_system: $BUILD_SYSTEM"
          BUILD_SYSTEM_SHA=$(resolve_ref "$BUILD_SYSTEM_URL" "$BUILD_SYSTEM" "build-system")
          if [ "$BUILD_SYSTEM_SHA" = "$BUILD_SYSTEM" ] && [ "$BUILD_SYSTEM" != "" ] && [[ ! "$BUILD_SYSTEM" =~ ^[0-9a-f]{40}$ ]]; then
            echo "  ‚Üí $BUILD_SYSTEM_SHA (‚ö†Ô∏è not resolved - will use ref as-is)"
          else
            echo "  ‚Üí $BUILD_SYSTEM_SHA ‚úì"
          fi
          
          echo "Resolving patches_public: $PATCHES_PUBLIC"
          PATCHES_PUBLIC_SHA=$(resolve_ref "$PATCHES_PUBLIC_URL" "$PATCHES_PUBLIC" "patches-public")
          if [ "$PATCHES_PUBLIC_SHA" = "$PATCHES_PUBLIC" ] && [ "$PATCHES_PUBLIC" != "" ] && [[ ! "$PATCHES_PUBLIC" =~ ^[0-9a-f]{40}$ ]]; then
            echo "  ‚Üí $PATCHES_PUBLIC_SHA (‚ö†Ô∏è not resolved - will use ref as-is)"
          else
            echo "  ‚Üí $PATCHES_PUBLIC_SHA ‚úì"
          fi
          
          echo "Resolving patches_private: $PATCHES_PRIVATE"
          PATCHES_PRIVATE_SHA=$(resolve_ref "$PATCHES_PRIVATE_URL" "$PATCHES_PRIVATE" "patches-private")
          if [ "$PATCHES_PRIVATE_SHA" = "$PATCHES_PRIVATE" ] && [ "$PATCHES_PRIVATE" != "" ] && [[ ! "$PATCHES_PRIVATE" =~ ^[0-9a-f]{40}$ ]]; then
            echo "  ‚Üí $PATCHES_PRIVATE_SHA (‚ö†Ô∏è not resolved - will use ref as-is)"
          else
            echo "  ‚Üí $PATCHES_PRIVATE_SHA ‚úì"
          fi
          
          # Output the frozen commit SHAs (or original ref if resolution failed)
          echo "brave_version=$BRAVE_VERSION" >> $GITHUB_OUTPUT
          echo "build_system=$BUILD_SYSTEM_SHA" >> $GITHUB_OUTPUT
          echo "patches_public=$PATCHES_PUBLIC_SHA" >> $GITHUB_OUTPUT
          echo "patches_private=$PATCHES_PRIVATE_SHA" >> $GITHUB_OUTPUT
          echo "allow_publish_release=$ALLOW_RELEASE" >> $GITHUB_OUTPUT
          echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "=== Frozen versions for this build run ==="
          echo "  brave_version=$BRAVE_VERSION"
          echo "  build_system=$BUILD_SYSTEM ‚Üí $BUILD_SYSTEM_SHA"
          echo "  patches_public=$PATCHES_PUBLIC ‚Üí $PATCHES_PUBLIC_SHA"
          echo "  patches_private=$PATCHES_PRIVATE ‚Üí $PATCHES_PRIVATE_SHA"
          echo ""
          echo "‚úì Commits frozen - all stages will use these exact commits"
          
          # ‚îÄ‚îÄ Build plan summary ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          # Show exactly which jobs will run vs skip so mis-clicks are
          # caught immediately instead of after 48+ hours.
          echo ""
          echo "=========================================="
          echo "  BUILD PLAN SUMMARY"
          echo "=========================================="
          echo ""
          
          TOTAL_PLATFORMS=0
          TOTAL_STAGES=0
          
          if [ "${{ inputs.build_linux_x64 }}" = "true" ]; then
            echo "  üêß Linux x64 .......... BUILD (16 stages)"
            TOTAL_PLATFORMS=$((TOTAL_PLATFORMS + 1))
            TOTAL_STAGES=$((TOTAL_STAGES + 16))
          else
            echo "  üêß Linux x64 .......... SKIP"
          fi
          
          if [ "${{ inputs.build_linux_arm64 }}" = "true" ]; then
            echo "  üêß Linux arm64 ........ BUILD (16 stages)"
            TOTAL_PLATFORMS=$((TOTAL_PLATFORMS + 1))
            TOTAL_STAGES=$((TOTAL_STAGES + 16))
          else
            echo "  üêß Linux arm64 ........ SKIP"
          fi
          
          if [ "${{ inputs.build_macos_x64 }}" = "true" ]; then
            echo "  üçé macOS x64 .......... BUILD (16 stages)"
            TOTAL_PLATFORMS=$((TOTAL_PLATFORMS + 1))
            TOTAL_STAGES=$((TOTAL_STAGES + 16))
          else
            echo "  üçé macOS x64 .......... SKIP"
          fi
          
          if [ "${{ inputs.build_macos_arm64 }}" = "true" ]; then
            echo "  üçé macOS arm64 ........ BUILD (16 stages)"
            TOTAL_PLATFORMS=$((TOTAL_PLATFORMS + 1))
            TOTAL_STAGES=$((TOTAL_STAGES + 16))
          else
            echo "  üçé macOS arm64 ........ SKIP"
          fi
          
          if [ "${{ inputs.build_windows_x64 }}" = "true" ]; then
            echo "  ü™ü Windows x64 ........ BUILD (16 stages)"
            TOTAL_PLATFORMS=$((TOTAL_PLATFORMS + 1))
            TOTAL_STAGES=$((TOTAL_STAGES + 16))
          else
            echo "  ü™ü Windows x64 ........ SKIP"
          fi
          
          if [ "${{ inputs.build_windows_arm64 }}" = "true" ]; then
            echo "  ü™ü Windows arm64 ...... BUILD (16 stages)"
            TOTAL_PLATFORMS=$((TOTAL_PLATFORMS + 1))
            TOTAL_STAGES=$((TOTAL_STAGES + 16))
          else
            echo "  ü™ü Windows arm64 ...... SKIP"
          fi
          
          if [ "${{ inputs.build_windows_x86 }}" = "true" ]; then
            echo "  ü™ü Windows x86 ........ BUILD (16 stages)"
            TOTAL_PLATFORMS=$((TOTAL_PLATFORMS + 1))
            TOTAL_STAGES=$((TOTAL_STAGES + 16))
          else
            echo "  ü™ü Windows x86 ........ SKIP"
          fi
          
          echo ""
          echo "------------------------------------------"
          echo "  Platforms: $TOTAL_PLATFORMS | Stages: $TOTAL_STAGES"
          echo "------------------------------------------"
          echo ""
          
          # Post-build jobs
          echo "  üì¶ Collect artifacts ... $([ $TOTAL_PLATFORMS -gt 0 ] && echo 'WILL RUN (after builds)' || echo 'SKIP (no builds)')"
          
          if [ "${{ inputs.publish_release }}" = "true" ] && [ "$ALLOW_RELEASE" = "true" ]; then
            echo "  üöÄ Publish release .... WILL RUN (after collect)"
            echo "     Environment: ${{ inputs.environment }}"
          elif [ "${{ inputs.publish_release }}" = "true" ] && [ "$ALLOW_RELEASE" != "true" ]; then
            echo "  üöÄ Publish release .... BLOCKED (environment '${{ inputs.environment }}' does not allow publishing)"
          else
            echo "  üöÄ Publish release .... SKIP (not requested)"
          fi
          
          echo ""
          
          if [ $TOTAL_PLATFORMS -eq 0 ]; then
            echo "=========================================="
            echo "  ‚ö†Ô∏è  WARNING: No platforms selected!"
            echo "  Nothing will be built. Is this intended?"
            echo "=========================================="
          fi
          
          echo ""
          echo "‚úì Validation complete"
      
      - name: Build plan summary
        run: |
          # Write a GitHub Actions job summary so the plan is visible
          # on the workflow run page without expanding any job logs.
          S=$GITHUB_STEP_SUMMARY
          
          echo "## üîç Build Plan" >> $S
          echo "" >> $S
          echo "| Platform | Status | Stages |" >> $S
          echo "|----------|--------|--------|" >> $S
          
          add_row() {
            local icon="$1" name="$2" enabled="$3"
            if [ "$enabled" = "true" ]; then
              echo "| $icon $name | ‚úÖ Build | 16 |" >> $S
            else
              echo "| $icon $name | ‚è≠Ô∏è Skip | ‚Äî |" >> $S
            fi
          }
          
          add_row "üêß" "Linux x64"     "${{ inputs.build_linux_x64 }}"
          add_row "üêß" "Linux arm64"   "${{ inputs.build_linux_arm64 }}"
          add_row "üçé" "macOS x64"     "${{ inputs.build_macos_x64 }}"
          add_row "üçé" "macOS arm64"   "${{ inputs.build_macos_arm64 }}"
          add_row "ü™ü" "Windows x64"   "${{ inputs.build_windows_x64 }}"
          add_row "ü™ü" "Windows arm64" "${{ inputs.build_windows_arm64 }}"
          add_row "ü™ü" "Windows x86"   "${{ inputs.build_windows_x86 }}"
          
          echo "" >> $S
          
          # Post-build status
          ALLOW_RELEASE="${{ steps.validate.outputs.allow_publish_release }}"
          
          if [ "${{ inputs.publish_release }}" = "true" ] && [ "$ALLOW_RELEASE" = "true" ]; then
            echo "**Publish release:** ‚úÖ Will publish after successful builds (environment: \`${{ inputs.environment }}\`)" >> $S
          elif [ "${{ inputs.publish_release }}" = "true" ] && [ "$ALLOW_RELEASE" != "true" ]; then
            echo "**Publish release:** ‚õî Requested but BLOCKED ‚Äî environment \`${{ inputs.environment }}\` does not allow publishing" >> $S
          else
            echo "**Publish release:** ‚è≠Ô∏è Not requested (test build)" >> $S
          fi
          
          echo "" >> $S
          echo "**Brave version:** \`${{ steps.validate.outputs.brave_version }}\`" >> $S
          echo "**Build system:** \`${{ steps.validate.outputs.build_system }}\`" >> $S

  # ============================================================================
  # Linux x64 Build Chain (16 stages)
  # ============================================================================
  
  linux-x64-build-1:
    name: Linux x64 - Stage 1/16
    needs: validate-config
    if: ${{ inputs.build_linux_x64 }}
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: x64
      stage: 1
      from_artifact: false
      finished: 'false'
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      patches_public_ref: ${{ needs.validate-config.outputs.patches_public }}
      patches_private_ref: ${{ needs.validate-config.outputs.patches_private }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-2:
    name: Linux x64 - Stage 2/16
    if: ${{ inputs.build_linux_x64 }}
    needs: [validate-config, linux-x64-build-1]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: x64
      stage: 2
      from_artifact: true
      finished: ${{ needs.linux-x64-build-1.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-3:
    name: Linux x64 - Stage 3/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-2.outputs.finished != 'true' }}
    needs: [validate-config, linux-x64-build-2]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: x64
      stage: 3
      from_artifact: true
      finished: ${{ needs.linux-x64-build-2.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-4:
    name: Linux x64 - Stage 4/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-3.outputs.finished != 'true' }}
    needs: [validate-config, linux-x64-build-3]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: x64
      stage: 4
      from_artifact: true
      finished: ${{ needs.linux-x64-build-3.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-5:
    name: Linux x64 - Stage 5/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-4.outputs.finished != 'true' }}
    needs: [validate-config, linux-x64-build-4]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: x64
      stage: 5
      from_artifact: true
      finished: ${{ needs.linux-x64-build-4.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-6:
    name: Linux x64 - Stage 6/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-5.outputs.finished != 'true' }}
    needs: [validate-config, linux-x64-build-5]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: x64
      stage: 6
      from_artifact: true
      finished: ${{ needs.linux-x64-build-5.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-7:
    name: Linux x64 - Stage 7/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-6.outputs.finished != 'true' }}
    needs: [validate-config, linux-x64-build-6]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: x64
      stage: 7
      from_artifact: true
      finished: ${{ needs.linux-x64-build-6.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-8:
    name: Linux x64 - Stage 8/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-7.outputs.finished != 'true' }}
    needs: [validate-config, linux-x64-build-7]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: x64
      stage: 8
      from_artifact: true
      finished: ${{ needs.linux-x64-build-7.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-9:
    name: Linux x64 - Stage 9/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-8.outputs.finished != 'true' }}
    needs: [validate-config, linux-x64-build-8]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: x64
      stage: 9
      from_artifact: true
      finished: ${{ needs.linux-x64-build-8.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-10:
    name: Linux x64 - Stage 10/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-9.outputs.finished != 'true' }}
    needs: [validate-config, linux-x64-build-9]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: x64
      stage: 10
      from_artifact: true
      finished: ${{ needs.linux-x64-build-9.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-11:
    name: Linux x64 - Stage 11/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-10.outputs.finished != 'true' }}
    needs: [validate-config, linux-x64-build-10]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: x64
      stage: 11
      from_artifact: true
      finished: ${{ needs.linux-x64-build-10.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-12:
    name: Linux x64 - Stage 12/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-11.outputs.finished != 'true' }}
    needs: [validate-config, linux-x64-build-11]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: x64
      stage: 12
      from_artifact: true
      finished: ${{ needs.linux-x64-build-11.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-13:
    name: Linux x64 - Stage 13/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-12.outputs.finished != 'true' }}
    needs: [validate-config, linux-x64-build-12]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: x64
      stage: 13
      from_artifact: true
      finished: ${{ needs.linux-x64-build-12.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-14:
    name: Linux x64 - Stage 14/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-13.outputs.finished != 'true' }}
    needs: [validate-config, linux-x64-build-13]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: x64
      stage: 14
      from_artifact: true
      finished: ${{ needs.linux-x64-build-13.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-15:
    name: Linux x64 - Stage 15/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-14.outputs.finished != 'true' }}
    needs: [validate-config, linux-x64-build-14]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: x64
      stage: 15
      from_artifact: true
      finished: ${{ needs.linux-x64-build-14.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-16:
    name: Linux x64 - Stage 16/16 (Final)
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-15.outputs.finished != 'true' }}
    needs: [validate-config, linux-x64-build-15]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: x64
      stage: 16
      from_artifact: true
      finished: ${{ needs.linux-x64-build-15.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  # ============================================================================
  # Windows x64 Build Chain (16 stages)
  # ============================================================================
  
  windows-x64-build-1:
    name: Windows x64 - Stage 1/16
    needs: validate-config
    if: ${{ inputs.build_windows_x64 }}
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x64
      stage: 1
      from_artifact: false
      finished: 'false'
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      patches_public_ref: ${{ needs.validate-config.outputs.patches_public }}
      patches_private_ref: ${{ needs.validate-config.outputs.patches_private }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-2:
    name: Windows x64 - Stage 2/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-1.outputs.finished != 'true' }}
    needs: [validate-config, windows-x64-build-1]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x64
      stage: 2
      from_artifact: true
      finished: ${{ needs.windows-x64-build-1.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-3:
    name: Windows x64 - Stage 3/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-2.outputs.finished != 'true' }}
    needs: [validate-config, windows-x64-build-2]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x64
      stage: 3
      from_artifact: true
      finished: ${{ needs.windows-x64-build-2.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-4:
    name: Windows x64 - Stage 4/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-3.outputs.finished != 'true' }}
    needs: [validate-config, windows-x64-build-3]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x64
      stage: 4
      from_artifact: true
      finished: ${{ needs.windows-x64-build-3.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-5:
    name: Windows x64 - Stage 5/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-4.outputs.finished != 'true' }}
    needs: [validate-config, windows-x64-build-4]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x64
      stage: 5
      from_artifact: true
      finished: ${{ needs.windows-x64-build-4.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-6:
    name: Windows x64 - Stage 6/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-5.outputs.finished != 'true' }}
    needs: [validate-config, windows-x64-build-5]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x64
      stage: 6
      from_artifact: true
      finished: ${{ needs.windows-x64-build-5.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-7:
    name: Windows x64 - Stage 7/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-6.outputs.finished != 'true' }}
    needs: [validate-config, windows-x64-build-6]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x64
      stage: 7
      from_artifact: true
      finished: ${{ needs.windows-x64-build-6.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-8:
    name: Windows x64 - Stage 8/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-7.outputs.finished != 'true' }}
    needs: [validate-config, windows-x64-build-7]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x64
      stage: 8
      from_artifact: true
      finished: ${{ needs.windows-x64-build-7.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-9:
    name: Windows x64 - Stage 9/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-8.outputs.finished != 'true' }}
    needs: [validate-config, windows-x64-build-8]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x64
      stage: 9
      from_artifact: true
      finished: ${{ needs.windows-x64-build-8.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-10:
    name: Windows x64 - Stage 10/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-9.outputs.finished != 'true' }}
    needs: [validate-config, windows-x64-build-9]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x64
      stage: 10
      from_artifact: true
      finished: ${{ needs.windows-x64-build-9.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-11:
    name: Windows x64 - Stage 11/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-10.outputs.finished != 'true' }}
    needs: [validate-config, windows-x64-build-10]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x64
      stage: 11
      from_artifact: true
      finished: ${{ needs.windows-x64-build-10.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-12:
    name: Windows x64 - Stage 12/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-11.outputs.finished != 'true' }}
    needs: [validate-config, windows-x64-build-11]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x64
      stage: 12
      from_artifact: true
      finished: ${{ needs.windows-x64-build-11.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-13:
    name: Windows x64 - Stage 13/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-12.outputs.finished != 'true' }}
    needs: [validate-config, windows-x64-build-12]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x64
      stage: 13
      from_artifact: true
      finished: ${{ needs.windows-x64-build-12.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-14:
    name: Windows x64 - Stage 14/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-13.outputs.finished != 'true' }}
    needs: [validate-config, windows-x64-build-13]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x64
      stage: 14
      from_artifact: true
      finished: ${{ needs.windows-x64-build-13.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-15:
    name: Windows x64 - Stage 15/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-14.outputs.finished != 'true' }}
    needs: [validate-config, windows-x64-build-14]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x64
      stage: 15
      from_artifact: true
      finished: ${{ needs.windows-x64-build-14.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-16:
    name: Windows x64 - Stage 16/16 (Final)
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-15.outputs.finished != 'true' }}
    needs: [validate-config, windows-x64-build-15]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x64
      stage: 16
      from_artifact: true
      finished: ${{ needs.windows-x64-build-15.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  # ============================================================================
  # Windows arm64 Build Chain (16 stages) - NEW!
  # ============================================================================
  
  windows-arm64-build-1:
    name: Windows arm64 - Stage 1/16
    needs: validate-config
    if: ${{ inputs.build_windows_arm64 }}
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: arm64
      stage: 1
      from_artifact: false
      finished: 'false'
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      patches_public_ref: ${{ needs.validate-config.outputs.patches_public }}
      patches_private_ref: ${{ needs.validate-config.outputs.patches_private }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-2:
    name: Windows arm64 - Stage 2/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-1.outputs.finished != 'true' }}
    needs: [validate-config, windows-arm64-build-1]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: arm64
      stage: 2
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-1.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-3:
    name: Windows arm64 - Stage 3/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-2.outputs.finished != 'true' }}
    needs: [validate-config, windows-arm64-build-2]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: arm64
      stage: 3
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-2.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-4:
    name: Windows arm64 - Stage 4/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-3.outputs.finished != 'true' }}
    needs: [validate-config, windows-arm64-build-3]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: arm64
      stage: 4
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-3.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-5:
    name: Windows arm64 - Stage 5/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-4.outputs.finished != 'true' }}
    needs: [validate-config, windows-arm64-build-4]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: arm64
      stage: 5
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-4.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-6:
    name: Windows arm64 - Stage 6/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-5.outputs.finished != 'true' }}
    needs: [validate-config, windows-arm64-build-5]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: arm64
      stage: 6
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-5.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-7:
    name: Windows arm64 - Stage 7/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-6.outputs.finished != 'true' }}
    needs: [validate-config, windows-arm64-build-6]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: arm64
      stage: 7
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-6.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-8:
    name: Windows arm64 - Stage 8/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-7.outputs.finished != 'true' }}
    needs: [validate-config, windows-arm64-build-7]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: arm64
      stage: 8
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-7.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-9:
    name: Windows arm64 - Stage 9/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-8.outputs.finished != 'true' }}
    needs: [validate-config, windows-arm64-build-8]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: arm64
      stage: 9
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-8.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-10:
    name: Windows arm64 - Stage 10/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-9.outputs.finished != 'true' }}
    needs: [validate-config, windows-arm64-build-9]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: arm64
      stage: 10
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-9.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-11:
    name: Windows arm64 - Stage 11/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-10.outputs.finished != 'true' }}
    needs: [validate-config, windows-arm64-build-10]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: arm64
      stage: 11
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-10.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-12:
    name: Windows arm64 - Stage 12/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-11.outputs.finished != 'true' }}
    needs: [validate-config, windows-arm64-build-11]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: arm64
      stage: 12
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-11.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-13:
    name: Windows arm64 - Stage 13/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-12.outputs.finished != 'true' }}
    needs: [validate-config, windows-arm64-build-12]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: arm64
      stage: 13
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-12.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-14:
    name: Windows arm64 - Stage 14/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-13.outputs.finished != 'true' }}
    needs: [validate-config, windows-arm64-build-13]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: arm64
      stage: 14
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-13.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-15:
    name: Windows arm64 - Stage 15/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-14.outputs.finished != 'true' }}
    needs: [validate-config, windows-arm64-build-14]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: arm64
      stage: 15
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-14.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-16:
    name: Windows arm64 - Stage 16/16 (Final)
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-15.outputs.finished != 'true' }}
    needs: [validate-config, windows-arm64-build-15]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: arm64
      stage: 16
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-15.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  # ============================================================================
  # Windows x86 Build Chain (16 stages) - Optional
  # ============================================================================
  
  windows-x86-build-1:
    name: Windows x86 - Stage 1/16
    needs: validate-config
    if: ${{ inputs.build_windows_x86 }}
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x86
      stage: 1
      from_artifact: false
      finished: 'false'
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      patches_public_ref: ${{ needs.validate-config.outputs.patches_public }}
      patches_private_ref: ${{ needs.validate-config.outputs.patches_private }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-2:
    name: Windows x86 - Stage 2/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-1.outputs.finished != 'true' }}
    needs: [validate-config, windows-x86-build-1]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x86
      stage: 2
      from_artifact: true
      finished: ${{ needs.windows-x86-build-1.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-3:
    name: Windows x86 - Stage 3/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-2.outputs.finished != 'true' }}
    needs: [validate-config, windows-x86-build-2]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x86
      stage: 3
      from_artifact: true
      finished: ${{ needs.windows-x86-build-2.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-4:
    name: Windows x86 - Stage 4/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-3.outputs.finished != 'true' }}
    needs: [validate-config, windows-x86-build-3]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x86
      stage: 4
      from_artifact: true
      finished: ${{ needs.windows-x86-build-3.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-5:
    name: Windows x86 - Stage 5/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-4.outputs.finished != 'true' }}
    needs: [validate-config, windows-x86-build-4]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x86
      stage: 5
      from_artifact: true
      finished: ${{ needs.windows-x86-build-4.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-6:
    name: Windows x86 - Stage 6/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-5.outputs.finished != 'true' }}
    needs: [validate-config, windows-x86-build-5]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x86
      stage: 6
      from_artifact: true
      finished: ${{ needs.windows-x86-build-5.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-7:
    name: Windows x86 - Stage 7/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-6.outputs.finished != 'true' }}
    needs: [validate-config, windows-x86-build-6]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x86
      stage: 7
      from_artifact: true
      finished: ${{ needs.windows-x86-build-6.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-8:
    name: Windows x86 - Stage 8/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-7.outputs.finished != 'true' }}
    needs: [validate-config, windows-x86-build-7]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x86
      stage: 8
      from_artifact: true
      finished: ${{ needs.windows-x86-build-7.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-9:
    name: Windows x86 - Stage 9/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-8.outputs.finished != 'true' }}
    needs: [validate-config, windows-x86-build-8]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x86
      stage: 9
      from_artifact: true
      finished: ${{ needs.windows-x86-build-8.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-10:
    name: Windows x86 - Stage 10/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-9.outputs.finished != 'true' }}
    needs: [validate-config, windows-x86-build-9]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x86
      stage: 10
      from_artifact: true
      finished: ${{ needs.windows-x86-build-9.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-11:
    name: Windows x86 - Stage 11/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-10.outputs.finished != 'true' }}
    needs: [validate-config, windows-x86-build-10]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x86
      stage: 11
      from_artifact: true
      finished: ${{ needs.windows-x86-build-10.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-12:
    name: Windows x86 - Stage 12/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-11.outputs.finished != 'true' }}
    needs: [validate-config, windows-x86-build-11]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x86
      stage: 12
      from_artifact: true
      finished: ${{ needs.windows-x86-build-11.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-13:
    name: Windows x86 - Stage 13/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-12.outputs.finished != 'true' }}
    needs: [validate-config, windows-x86-build-12]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x86
      stage: 13
      from_artifact: true
      finished: ${{ needs.windows-x86-build-12.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-14:
    name: Windows x86 - Stage 14/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-13.outputs.finished != 'true' }}
    needs: [validate-config, windows-x86-build-13]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x86
      stage: 14
      from_artifact: true
      finished: ${{ needs.windows-x86-build-13.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-15:
    name: Windows x86 - Stage 15/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-14.outputs.finished != 'true' }}
    needs: [validate-config, windows-x86-build-14]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x86
      stage: 15
      from_artifact: true
      finished: ${{ needs.windows-x86-build-14.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-16:
    name: Windows x86 - Stage 16/16 (Final)
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-15.outputs.finished != 'true' }}
    needs: [validate-config, windows-x86-build-15]
    uses: ./.github/workflows/builder.yml
    with:
      platform: windows
      arch: x86
      stage: 16
      from_artifact: true
      finished: ${{ needs.windows-x86-build-15.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  # ============================================================================
  # macOS x64 Build Chain (16 stages)
  # ============================================================================
  
  macos-x64-build-1:
    name: macOS x64 - Stage 1/16
    needs: validate-config
    if: ${{ inputs.build_macos_x64 }}
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: x64
      stage: 1
      from_artifact: false
      finished: 'false'
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      patches_public_ref: ${{ needs.validate-config.outputs.patches_public }}
      patches_private_ref: ${{ needs.validate-config.outputs.patches_private }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-2:
    name: macOS x64 - Stage 2/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-1.outputs.finished != 'true' }}
    needs: [validate-config, macos-x64-build-1]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: x64
      stage: 2
      from_artifact: true
      finished: ${{ needs.macos-x64-build-1.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-3:
    name: macOS x64 - Stage 3/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-2.outputs.finished != 'true' }}
    needs: [validate-config, macos-x64-build-2]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: x64
      stage: 3
      from_artifact: true
      finished: ${{ needs.macos-x64-build-2.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-4:
    name: macOS x64 - Stage 4/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-3.outputs.finished != 'true' }}
    needs: [validate-config, macos-x64-build-3]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: x64
      stage: 4
      from_artifact: true
      finished: ${{ needs.macos-x64-build-3.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-5:
    name: macOS x64 - Stage 5/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-4.outputs.finished != 'true' }}
    needs: [validate-config, macos-x64-build-4]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: x64
      stage: 5
      from_artifact: true
      finished: ${{ needs.macos-x64-build-4.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-6:
    name: macOS x64 - Stage 6/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-5.outputs.finished != 'true' }}
    needs: [validate-config, macos-x64-build-5]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: x64
      stage: 6
      from_artifact: true
      finished: ${{ needs.macos-x64-build-5.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-7:
    name: macOS x64 - Stage 7/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-6.outputs.finished != 'true' }}
    needs: [validate-config, macos-x64-build-6]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: x64
      stage: 7
      from_artifact: true
      finished: ${{ needs.macos-x64-build-6.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-8:
    name: macOS x64 - Stage 8/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-7.outputs.finished != 'true' }}
    needs: [validate-config, macos-x64-build-7]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: x64
      stage: 8
      from_artifact: true
      finished: ${{ needs.macos-x64-build-7.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-9:
    name: macOS x64 - Stage 9/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-8.outputs.finished != 'true' }}
    needs: [validate-config, macos-x64-build-8]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: x64
      stage: 9
      from_artifact: true
      finished: ${{ needs.macos-x64-build-8.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-10:
    name: macOS x64 - Stage 10/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-9.outputs.finished != 'true' }}
    needs: [validate-config, macos-x64-build-9]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: x64
      stage: 10
      from_artifact: true
      finished: ${{ needs.macos-x64-build-9.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-11:
    name: macOS x64 - Stage 11/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-10.outputs.finished != 'true' }}
    needs: [validate-config, macos-x64-build-10]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: x64
      stage: 11
      from_artifact: true
      finished: ${{ needs.macos-x64-build-10.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-12:
    name: macOS x64 - Stage 12/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-11.outputs.finished != 'true' }}
    needs: [validate-config, macos-x64-build-11]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: x64
      stage: 12
      from_artifact: true
      finished: ${{ needs.macos-x64-build-11.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-13:
    name: macOS x64 - Stage 13/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-12.outputs.finished != 'true' }}
    needs: [validate-config, macos-x64-build-12]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: x64
      stage: 13
      from_artifact: true
      finished: ${{ needs.macos-x64-build-12.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-14:
    name: macOS x64 - Stage 14/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-13.outputs.finished != 'true' }}
    needs: [validate-config, macos-x64-build-13]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: x64
      stage: 14
      from_artifact: true
      finished: ${{ needs.macos-x64-build-13.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-15:
    name: macOS x64 - Stage 15/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-14.outputs.finished != 'true' }}
    needs: [validate-config, macos-x64-build-14]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: x64
      stage: 15
      from_artifact: true
      finished: ${{ needs.macos-x64-build-14.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-16:
    name: macOS x64 - Stage 16/16 (Final)
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-15.outputs.finished != 'true' }}
    needs: [validate-config, macos-x64-build-15]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: x64
      stage: 16
      from_artifact: true
      finished: ${{ needs.macos-x64-build-15.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  # ============================================================================
  # macOS arm64 Build Chain (16 stages)
  # ============================================================================
  
  macos-arm64-build-1:
    name: macOS arm64 - Stage 1/16
    needs: validate-config
    if: ${{ inputs.build_macos_arm64 }}
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: arm64
      stage: 1
      from_artifact: false
      finished: 'false'
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      patches_public_ref: ${{ needs.validate-config.outputs.patches_public }}
      patches_private_ref: ${{ needs.validate-config.outputs.patches_private }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-2:
    name: macOS arm64 - Stage 2/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-1.outputs.finished != 'true' }}
    needs: [validate-config, macos-arm64-build-1]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: arm64
      stage: 2
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-1.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-3:
    name: macOS arm64 - Stage 3/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-2.outputs.finished != 'true' }}
    needs: [validate-config, macos-arm64-build-2]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: arm64
      stage: 3
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-2.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-4:
    name: macOS arm64 - Stage 4/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-3.outputs.finished != 'true' }}
    needs: [validate-config, macos-arm64-build-3]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: arm64
      stage: 4
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-3.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-5:
    name: macOS arm64 - Stage 5/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-4.outputs.finished != 'true' }}
    needs: [validate-config, macos-arm64-build-4]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: arm64
      stage: 5
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-4.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-6:
    name: macOS arm64 - Stage 6/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-5.outputs.finished != 'true' }}
    needs: [validate-config, macos-arm64-build-5]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: arm64
      stage: 6
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-5.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-7:
    name: macOS arm64 - Stage 7/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-6.outputs.finished != 'true' }}
    needs: [validate-config, macos-arm64-build-6]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: arm64
      stage: 7
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-6.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-8:
    name: macOS arm64 - Stage 8/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-7.outputs.finished != 'true' }}
    needs: [validate-config, macos-arm64-build-7]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: arm64
      stage: 8
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-7.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-9:
    name: macOS arm64 - Stage 9/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-8.outputs.finished != 'true' }}
    needs: [validate-config, macos-arm64-build-8]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: arm64
      stage: 9
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-8.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-10:
    name: macOS arm64 - Stage 10/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-9.outputs.finished != 'true' }}
    needs: [validate-config, macos-arm64-build-9]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: arm64
      stage: 10
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-9.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-11:
    name: macOS arm64 - Stage 11/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-10.outputs.finished != 'true' }}
    needs: [validate-config, macos-arm64-build-10]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: arm64
      stage: 11
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-10.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-12:
    name: macOS arm64 - Stage 12/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-11.outputs.finished != 'true' }}
    needs: [validate-config, macos-arm64-build-11]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: arm64
      stage: 12
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-11.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-13:
    name: macOS arm64 - Stage 13/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-12.outputs.finished != 'true' }}
    needs: [validate-config, macos-arm64-build-12]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: arm64
      stage: 13
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-12.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-14:
    name: macOS arm64 - Stage 14/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-13.outputs.finished != 'true' }}
    needs: [validate-config, macos-arm64-build-13]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: arm64
      stage: 14
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-13.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-15:
    name: macOS arm64 - Stage 15/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-14.outputs.finished != 'true' }}
    needs: [validate-config, macos-arm64-build-14]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: arm64
      stage: 15
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-14.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-16:
    name: macOS arm64 - Stage 16/16 (Final)
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-15.outputs.finished != 'true' }}
    needs: [validate-config, macos-arm64-build-15]
    uses: ./.github/workflows/builder.yml
    with:
      platform: macos
      arch: arm64
      stage: 16
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-15.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  # ============================================================================
  # Linux arm64 Build Chain (16 stages)
  # ============================================================================
  
  linux-arm64-build-1:
    name: Linux arm64 - Stage 1/16
    needs: validate-config
    if: ${{ inputs.build_linux_arm64 }}
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: arm64
      stage: 1
      from_artifact: false
      finished: 'false'
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      patches_public_ref: ${{ needs.validate-config.outputs.patches_public }}
      patches_private_ref: ${{ needs.validate-config.outputs.patches_private }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-2:
    name: Linux arm64 - Stage 2/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-1.outputs.finished != 'true' }}
    needs: [validate-config, linux-arm64-build-1]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: arm64
      stage: 2
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-1.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-3:
    name: Linux arm64 - Stage 3/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-2.outputs.finished != 'true' }}
    needs: [validate-config, linux-arm64-build-2]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: arm64
      stage: 3
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-2.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-4:
    name: Linux arm64 - Stage 4/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-3.outputs.finished != 'true' }}
    needs: [validate-config, linux-arm64-build-3]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: arm64
      stage: 4
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-3.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-5:
    name: Linux arm64 - Stage 5/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-4.outputs.finished != 'true' }}
    needs: [validate-config, linux-arm64-build-4]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: arm64
      stage: 5
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-4.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-6:
    name: Linux arm64 - Stage 6/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-5.outputs.finished != 'true' }}
    needs: [validate-config, linux-arm64-build-5]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: arm64
      stage: 6
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-5.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-7:
    name: Linux arm64 - Stage 7/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-6.outputs.finished != 'true' }}
    needs: [validate-config, linux-arm64-build-6]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: arm64
      stage: 7
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-6.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-8:
    name: Linux arm64 - Stage 8/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-7.outputs.finished != 'true' }}
    needs: [validate-config, linux-arm64-build-7]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: arm64
      stage: 8
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-7.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-9:
    name: Linux arm64 - Stage 9/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-8.outputs.finished != 'true' }}
    needs: [validate-config, linux-arm64-build-8]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: arm64
      stage: 9
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-8.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-10:
    name: Linux arm64 - Stage 10/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-9.outputs.finished != 'true'  }}
    needs: [validate-config, linux-arm64-build-9]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: arm64
      stage: 10
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-9.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-11:
    name: Linux arm64 - Stage 11/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-10.outputs.finished != 'true' }}
    needs: [validate-config, linux-arm64-build-10]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: arm64
      stage: 11
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-10.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-12:
    name: Linux arm64 - Stage 12/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-11.outputs.finished != 'true' }}
    needs: [validate-config, linux-arm64-build-11]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: arm64
      stage: 12
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-11.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-13:
    name: Linux arm64 - Stage 13/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-12.outputs.finished != 'true' }}
    needs: [validate-config, linux-arm64-build-12]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: arm64
      stage: 13
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-12.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-14:
    name: Linux arm64 - Stage 14/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-13.outputs.finished != 'true' }}
    needs: [validate-config, linux-arm64-build-13]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: arm64
      stage: 14
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-13.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-15:
    name: Linux arm64 - Stage 15/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-14.outputs.finished != 'true' }}
    needs: [validate-config, linux-arm64-build-14]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: arm64
      stage: 15
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-14.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-16:
    name: Linux arm64 - Stage 16/16 (Final)
    if: ${{ inputs.build_linux_arm64  && needs.linux-arm64-build-15.outputs.finished != 'true' }}
    needs: [validate-config, linux-arm64-build-15]
    uses: ./.github/workflows/builder.yml
    with:
      platform: linux
      arch: arm64
      stage: 16
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-15.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
      build_system_ref: ${{ needs.validate-config.outputs.build_system }}
      brave_version: ${{ needs.validate-config.outputs.brave_version }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  # ============================================================================
  # Collect All Artifacts - Waits for ALL selected builds to complete
  # ============================================================================
  
  collect-artifacts:
    name: Collect All Build Artifacts
    needs: [
      validate-config,
      linux-x64-build-16,
      linux-arm64-build-16,
      macos-x64-build-16,
      macos-arm64-build-16,
      windows-x64-build-16,
      windows-arm64-build-16,
      windows-x86-build-16
    ]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download Linux x64 artifact
        if: ${{ inputs.build_linux_x64 }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: brave-browser-linux
          path: ./artifacts/linux-x64
      
      - name: Download Linux arm64 artifact
        if: ${{ inputs.build_linux_arm64 }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: brave-browser-linux-arm64
          path: ./artifacts/linux-arm64
      
      - name: Download macOS x64 artifact
        if: ${{ inputs.build_macos_x64 }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: brave-browser-macos
          path: ./artifacts/macos-x64
      
      - name: Download macOS arm64 artifact
        if: ${{ inputs.build_macos_arm64 }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: brave-browser-macos-arm64
          path: ./artifacts/macos-arm64
      
      - name: Download Windows x64 artifact
        if: ${{ inputs.build_windows_x64 }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: brave-browser-windows
          path: ./artifacts/windows-x64
      
      - name: Download Windows arm64 artifact
        if: ${{ inputs.build_windows_arm64 }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: brave-browser-windows-arm64
          path: ./artifacts/windows-arm64
      
      - name: Download Windows x86 artifact
        if: ${{ inputs.build_windows_x86 }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: brave-browser-windows-x86
          path: ./artifacts/windows-x86
      
      - name: List all artifacts
        run: |
          echo "=== All Build Artifacts ==="
          if [ -d ./artifacts ]; then
            find ./artifacts -type f -exec ls -lh {} \;
          else
            echo "No artifacts directory found"
          fi
          echo ""
          echo "‚úì All selected builds completed!"
          if [ "${{ inputs.publish_release }}" == "true" ] && [ "${{ needs.validate-config.outputs.allow_publish_release }}" == "true" ]; then
            echo "‚úì Ready for release publishing"
          else
            echo "‚ÑπÔ∏è  Test build - artifacts available in workflow run"
            echo "‚ÑπÔ∏è  Release publishing is disabled (requires publish_release=true and ALLOW_PUBLISH_RELEASE variable=true)"
          fi
      
      - name: Verify encrypted artifacts
        run: |
          echo "=== Verifying Encrypted Artifacts ==="
          cd ./artifacts
          
          # List all encrypted files (checksums will be generated after decryption in publish-release)
          echo "Encrypted packages (GPG - Linux/macOS):"
          find . -type f -name "*.gpg" -exec ls -lh {} \; || echo "  (none)"
          
          echo ""
          echo "Encrypted packages (7z - Windows):"
          find . -type f -name "*.7z" -exec ls -lh {} \; || echo "  (none)"
          
          echo ""
          echo "Note: SHA256 checksums will be generated after decryption in publish-release job"
      
      
      - name: Upload combined artifacts for release
        uses: actions/upload-artifact@v4
        with:
          name: brave-browser-all-platforms
          path: ./artifacts/
          retention-days: 7

  # ============================================================================
  # Publish Release - Optional, With Optional Manual Approval
  # ============================================================================
  
  publish-release:
    name: üì¶ Publish Release
    if: ${{ always() && needs.collect-artifacts.result == 'success' && inputs.publish_release && needs.validate-config.outputs.allow_publish_release == 'true' }}
    needs: [validate-config, collect-artifacts]
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Download all platform artifacts
        uses: actions/download-artifact@v4
        with:
          name: brave-browser-all-platforms
          path: ./release
      
      - name: Display encrypted contents
        run: |
          echo "=== Downloaded Encrypted Artifacts ==="
          find ./release -type f -exec ls -lh {} \;
          echo ""
      
      - name: Decrypt artifacts (GPG - Linux/macOS)
        env:
          ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
        run: |
          echo "=== Decrypting GPG-encrypted artifacts ==="
          
          if [ -z "$ARCHIVE_PASSWORD" ]; then
            echo "‚ö†Ô∏è  ARCHIVE_PASSWORD not set - checking for unencrypted files"
          else
            echo "‚úì ARCHIVE_PASSWORD is set"
          fi
          
          # Find and decrypt all .gpg files (Linux/macOS packages)
          find ./release -name "*.gpg" | while read -r gpg_file; do
            echo "Decrypting: $gpg_file"
            output_file="${gpg_file%.gpg}"
            
            echo "$ARCHIVE_PASSWORD" | gpg --batch --yes --passphrase-fd 0 --decrypt --output "$output_file" "$gpg_file"
            
            if [ $? -eq 0 ]; then
              echo "‚úì Decrypted to: $output_file"
              rm "$gpg_file"
            else
              echo "‚úó Failed to decrypt: $gpg_file"
              exit 1
            fi
          done
          
          echo "‚úì GPG decryption complete"
      
      - name: Decrypt artifacts (7z - Windows)
        env:
          ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
        run: |
          echo "=== Decrypting 7z-encrypted artifacts ==="
          
          # Install p7zip for extracting 7z files
          sudo apt-get update && sudo apt-get install -y p7zip-full
          
          # Find and decrypt all .7z files (Windows packages)
          find ./release -name "*.7z" | while read -r sevenzip_file; do
            echo "Decrypting: $sevenzip_file"
            output_dir=$(dirname "$sevenzip_file")
            
            7z x "$sevenzip_file" -o"$output_dir" -p"$ARCHIVE_PASSWORD" -y
            
            if [ $? -eq 0 ]; then
              echo "‚úì Extracted to: $output_dir"
              rm "$sevenzip_file"
            else
              echo "‚úó Failed to decrypt: $sevenzip_file"
              exit 1
            fi
          done
          
          echo "‚úì 7z decryption complete"
      
      - name: Display decrypted release contents
        run: |
          echo "=== Decrypted Release Contents ==="
          find ./release -type f -exec ls -lh {} \;
          echo ""
      
      - name: Encrypt release artifacts (AES-256-GCM)
        run: |
          echo "=== Encrypting release artifacts with AES-256-GCM ==="
          
          # This key is INTENTIONALLY PUBLIC. Its only purpose is to prevent
          # non-technical users from accidentally downloading and running the
          # browser outside the launcher. If you need the key, here it is.
          # Use the launcher instead: https://browser.omeglelike.com
          RELEASE_ENCRYPTION_KEY="8488feb81de4054780571ccacf709a33074b23665b64ec7114301c60ab102b15"
          
          cd ./release
          
          # Encrypt each .zip file with AES-256-GCM
          # Format: [12-byte nonce][ciphertext + 16-byte GCM auth tag]
          find . -type f -name "*.zip" | while read -r file; do
            echo "Encrypting: $file"
            
            # Generate a random 12-byte nonce (IV)
            NONCE=$(openssl rand -hex 12)
            NONCE_BIN=$(echo -n "$NONCE" | xxd -r -p)
            
            # Encrypt with AES-256-GCM
            # openssl outputs ciphertext + 16-byte auth tag
            openssl enc -aes-256-gcm \
              -in "$file" \
              -out "${file}.enc.tmp" \
              -K "$RELEASE_ENCRYPTION_KEY" \
              -iv "$NONCE" \
              -nosalt
            
            # Prepend the 12-byte nonce to create final format: [nonce][ciphertext+tag]
            enc_file="${file%.zip}.enc"
            printf '%s' "$NONCE_BIN" > "$enc_file"
            cat "${file}.enc.tmp" >> "$enc_file"
            rm "${file}.enc.tmp"
            
            # Verify the encrypted file was created
            if [ -f "$enc_file" ]; then
              orig_size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
              enc_size=$(stat -c%s "$enc_file" 2>/dev/null || stat -f%z "$enc_file")
              echo "‚úì Encrypted: $file ($orig_size bytes) -> $enc_file ($enc_size bytes)"
              rm "$file"
            else
              echo "‚úó Failed to encrypt: $file"
              exit 1
            fi
          done
          
          echo "‚úì AES-256-GCM encryption complete"
      
      - name: Generate checksums for release
        run: |
          echo "=== Generating SHA256 checksums ==="
          cd ./release
          
          # Generate SHA256 for all encrypted release archives (.enc files)
          find . -type f -name "*.enc" | while read -r file; do
            echo "Generating checksum for: $file"
            checksum=$(sha256sum "$file" | sed 's|./||')
            echo "$checksum" > "$file.sha256"
            echo "Created: $file.sha256"
            echo "SHA256: $checksum"
          done
          
          echo ""
          echo "=== Checksum Summary ==="
          find . -name "*.sha256" | while read -r checksum_file; do
            artifact_file="${checksum_file%.sha256}"
            checksum=$(cat "$checksum_file")
            filename=$(basename "$artifact_file")
            echo "$checksum  $filename"
          done
          
          echo ""
          echo "Publishing to GitHub Releases..."
      
      - name: Generate build summary
        id: summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # üéâ Brave Browser Build Complete (16-Stage)
          
          ## üì¶ Build Configuration
          
          | Platform | Status | Build Type |
          |----------|--------|------------|
          | üêß Linux x64 | ${{ inputs.build_linux_x64 && '‚úÖ Built' || '‚è≠Ô∏è Skipped' }} | ${{ inputs.build_type }} |
          | üêß Linux arm64 | ${{ inputs.build_linux_arm64 && '‚úÖ Built' || '‚è≠Ô∏è Skipped' }} | ${{ inputs.build_type }} |
          | üçé macOS x64 | ${{ inputs.build_macos_x64 && '‚úÖ Built' || '‚è≠Ô∏è Skipped' }} | ${{ inputs.build_type }} |
          | üçé macOS arm64 | ${{ inputs.build_macos_arm64 && '‚úÖ Built' || '‚è≠Ô∏è Skipped' }} | ${{ inputs.build_type }} |
          | ü™ü Windows x64 | ${{ inputs.build_windows_x64 && '‚úÖ Built' || '‚è≠Ô∏è Skipped' }} | ${{ inputs.build_type }} |
          | ü™ü Windows arm64 | ${{ inputs.build_windows_arm64 && '‚úÖ Built' || '‚è≠Ô∏è Skipped' }} | ${{ inputs.build_type }} |
          | ü™ü Windows x86 | ${{ inputs.build_windows_x86 && '‚úÖ Built' || '‚è≠Ô∏è Skipped' }} | ${{ inputs.build_type }} |
            
          ## üîê Security & Verification
          
          - **Checksums**: SHA256 generated for all artifacts
          - **Release Type**: Pre-release (custom rebuild)
          
          ## üìä Release Status
          
          - **Publishing**: ${{ inputs.publish_release && '‚úÖ Requested' || '‚ùå Disabled' }} (ALLOW_PUBLISH_RELEASE variable controls actual publishing)
          - **Environment**: ${{ inputs.environment && inputs.environment || '‚è≠Ô∏è None selected' }}
          - **Workflow Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          
          **Build triggered by:** @${{ github.actor }} | **Commit:** `${{ github.sha }}`
          EOF
          
          PLATFORMS=""
          ${{ inputs.build_linux_x64 }} && PLATFORMS="${PLATFORMS}- Linux x64\n"
          ${{ inputs.build_linux_arm64 }} && PLATFORMS="${PLATFORMS}- Linux arm64\n"
          ${{ inputs.build_macos_x64 }} && PLATFORMS="${PLATFORMS}- macOS x64\n"
          ${{ inputs.build_macos_arm64 }} && PLATFORMS="${PLATFORMS}- macOS arm64\n"
          ${{ inputs.build_windows_x64 }} && PLATFORMS="${PLATFORMS}- Windows x64\n"
          ${{ inputs.build_windows_arm64 }} && PLATFORMS="${PLATFORMS}- Windows arm64\n"
          ${{ inputs.build_windows_x86 }} && PLATFORMS="${PLATFORMS}- Windows x86\n"
          echo "platforms<<EOF" >> $GITHUB_OUTPUT
          echo -e "$PLATFORMS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}-${{ github.sha }}
          name: Brave Browser Build ${{ github.run_number }} (16-Stage)
          body: |
            ## Brave Browser - Multi-Platform Build (16-Stage Reliability)
            
            **Build**: #${{ github.run_number }}
            **Commit**: ${{ github.sha }}
            **Triggered by**: @${{ github.actor }}
            **Date**: ${{ github.event.repository.updated_at }}
            **Stages per platform**: 16 (for maximum reliability)
            
            ### Platforms Included:
            ${{ steps.summary.outputs.platforms }}
            
            ### ‚ö†Ô∏è Encrypted Artifacts
            
            Release artifacts are **AES-256-GCM encrypted** (`.enc` files).
            **This browser is not intended to be downloaded and run manually.**
            
            Please use the official launcher instead: https://browser.omeglelike.com
            
            The launcher handles downloading, decryption, verification, and installation automatically.
            If you really need the decryption key, you can find it in the launcher's source code.
            
            ### Build Details
            - **16 stages per platform** for maximum reliability
            - Each stage runs for ~18-20 minutes
            - Better checkpoint granularity reduces risk of failures
            
            **Note:** This is a custom rebuild with symbol stripping for size/speed optimization.
          draft: false
          prerelease: true
          fail_on_unmatched_files: true
          files: |
            ./release/**/*.enc
            ./release/**/*.sha256
      
      - name: Release published
        run: |
          echo "‚úì Release published successfully!"
          echo "Check: https://github.com/${{ github.repository }}/releases"
