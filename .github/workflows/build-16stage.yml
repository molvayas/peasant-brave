name: Build Brave Browser (16-Stage - All Platforms)

on:
  workflow_dispatch:
    inputs:
      build_linux_x64:
        description: 'Build Linux x64'
        required: true
        type: boolean
        default: true
      build_linux_arm64:
        description: 'Build Linux arm64'
        required: true
        type: boolean
        default: false
      build_macos_x64:
        description: 'Build macOS x64'
        required: true
        type: boolean
        default: true
      build_macos_arm64:
        description: 'Build macOS arm64'
        required: true
        type: boolean
        default: false
      build_windows_x64:
        description: 'Build Windows x64'
        required: true
        type: boolean
        default: true
      build_windows_arm64:
        description: 'Build Windows arm64'
        required: true
        type: boolean
        default: false
      build_windows_x86:
        description: 'Build Windows x86 (32-bit)'
        required: true
        type: boolean
        default: false
      environment:
        description: 'Deployment environment'
        required: false
        type: environment
      publish_release:
        description: 'Publish GitHub release (uncheck for test builds)'
        required: true
        type: boolean
        default: false
      version_override:
        description: 'Override versions (format: brave_version=v1.85.74;build_system=main) - BLOCKED if ALLOW_PUBLISH_RELEASE=true'
        required: false
        type: string
        default: ''

jobs:
  # ============================================================================
  # Validate Configuration - Runs First, Blocks Invalid Overrides
  # ============================================================================
  
  validate-config:
    name: üîç Validate Configuration
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      brave_version: ${{ steps.validate.outputs.brave_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Validate version configuration
        id: validate
        run: |
          echo "=== Version Configuration Validation ==="
          
          VERSION_OVERRIDE="${{ inputs.version_override }}"
          ALLOW_RELEASE="${{ vars.ALLOW_PUBLISH_RELEASE }}"
          
          # Check if override is provided
          if [ -n "$VERSION_OVERRIDE" ]; then
            echo "Version override requested: $VERSION_OVERRIDE"
            echo ""
            
            # Block override if ALLOW_PUBLISH_RELEASE is true
            if [ "$ALLOW_RELEASE" = "true" ]; then
              echo "=========================================="
              echo "FATAL: Version override is BLOCKED!"
              echo ""
              echo "ALLOW_PUBLISH_RELEASE=true means this repository"
              echo "can publish releases. Version overrides are not"
              echo "allowed in release-capable repositories."
              echo ""
              echo "To use version overrides, set ALLOW_PUBLISH_RELEASE"
              echo "to 'false' or remove the variable."
              echo "=========================================="
              exit 1
            fi
            
            echo "‚úì Override allowed (ALLOW_PUBLISH_RELEASE is not 'true')"
            echo ""
            
            # Parse and apply overrides to versions.txt
            cp versions.txt versions.txt.bak
            
            # Valid keys
            VALID_KEYS="brave_version build_system patches_public patches_private"
            
            IFS=';' read -ra OVERRIDES <<< "$VERSION_OVERRIDE"
            for override in "${OVERRIDES[@]}"; do
              [ -z "$override" ] && continue
              
              # Validate format
              if [[ ! "$override" =~ ^[a-z_]+=[a-zA-Z0-9._/-]+$ ]]; then
                echo "=========================================="
                echo "FATAL: Invalid override format: '$override'"
                echo ""
                echo "Expected: key=value (e.g., brave_version=v1.85.74)"
                echo "Valid keys: $VALID_KEYS"
                echo "=========================================="
                exit 1
              fi
              
              key="${override%%=*}"
              value="${override#*=}"
              
              # Check key is valid
              if ! echo "$VALID_KEYS" | grep -qw "$key"; then
                echo "=========================================="
                echo "FATAL: Unknown key: '$key'"
                echo "Valid keys: $VALID_KEYS"
                echo "=========================================="
                exit 1
              fi
              
              # Apply override (replace or add)
              if grep -q "^${key}=" versions.txt; then
                sed -i "s|^${key}=.*|${key}=${value}|" versions.txt
              else
                echo "${key}=${value}" >> versions.txt
              fi
              echo "‚úì Override applied: $key=$value"
            done
            
            echo ""
            echo "‚ö†Ô∏è  WARNING: Using overridden versions (test build only)"
          else
            echo "No version override - using committed versions.txt"
          fi
          
          # Show final versions
          echo ""
          echo "=== Final Version Configuration ==="
          cat versions.txt
          
          # Extract brave_version for output
          BRAVE_VERSION=$(grep -E "^brave_version=" versions.txt | cut -d'=' -f2 | tr -d ' ')
          echo "brave_version=$BRAVE_VERSION" >> $GITHUB_OUTPUT
          
          echo ""
          echo "‚úì Validation complete"

  # ============================================================================
  # Linux x64 Build Chain (16 stages)
  # ============================================================================
  
  linux-x64-build-1:
    name: Linux x64 - Stage 1/16
    needs: validate-config
    if: ${{ inputs.build_linux_x64 }}
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: x64
      stage: 1
      from_artifact: false
      finished: 'false'
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-2:
    name: Linux x64 - Stage 2/16
    if: ${{ inputs.build_linux_x64 }}
    needs: linux-x64-build-1
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: x64
      stage: 2
      from_artifact: true
      finished: ${{ needs.linux-x64-build-1.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-3:
    name: Linux x64 - Stage 3/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-2.outputs.finished != 'true' }}
    needs: linux-x64-build-2
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: x64
      stage: 3
      from_artifact: true
      finished: ${{ needs.linux-x64-build-2.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-4:
    name: Linux x64 - Stage 4/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-3.outputs.finished != 'true' }}
    needs: linux-x64-build-3
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: x64
      stage: 4
      from_artifact: true
      finished: ${{ needs.linux-x64-build-3.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-5:
    name: Linux x64 - Stage 5/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-4.outputs.finished != 'true' }}
    needs: linux-x64-build-4
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: x64
      stage: 5
      from_artifact: true
      finished: ${{ needs.linux-x64-build-4.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-6:
    name: Linux x64 - Stage 6/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-5.outputs.finished != 'true' }}
    needs: linux-x64-build-5
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: x64
      stage: 6
      from_artifact: true
      finished: ${{ needs.linux-x64-build-5.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-7:
    name: Linux x64 - Stage 7/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-6.outputs.finished != 'true' }}
    needs: linux-x64-build-6
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: x64
      stage: 7
      from_artifact: true
      finished: ${{ needs.linux-x64-build-6.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-8:
    name: Linux x64 - Stage 8/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-7.outputs.finished != 'true' }}
    needs: linux-x64-build-7
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: x64
      stage: 8
      from_artifact: true
      finished: ${{ needs.linux-x64-build-7.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-9:
    name: Linux x64 - Stage 9/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-8.outputs.finished != 'true' }}
    needs: linux-x64-build-8
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: x64
      stage: 9
      from_artifact: true
      finished: ${{ needs.linux-x64-build-8.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-10:
    name: Linux x64 - Stage 10/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-9.outputs.finished != 'true' }}
    needs: linux-x64-build-9
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: x64
      stage: 10
      from_artifact: true
      finished: ${{ needs.linux-x64-build-9.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-11:
    name: Linux x64 - Stage 11/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-10.outputs.finished != 'true' }}
    needs: linux-x64-build-10
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: x64
      stage: 11
      from_artifact: true
      finished: ${{ needs.linux-x64-build-10.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-12:
    name: Linux x64 - Stage 12/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-11.outputs.finished != 'true' }}
    needs: linux-x64-build-11
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: x64
      stage: 12
      from_artifact: true
      finished: ${{ needs.linux-x64-build-11.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-13:
    name: Linux x64 - Stage 13/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-12.outputs.finished != 'true' }}
    needs: linux-x64-build-12
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: x64
      stage: 13
      from_artifact: true
      finished: ${{ needs.linux-x64-build-12.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-14:
    name: Linux x64 - Stage 14/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-13.outputs.finished != 'true' }}
    needs: linux-x64-build-13
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: x64
      stage: 14
      from_artifact: true
      finished: ${{ needs.linux-x64-build-13.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-15:
    name: Linux x64 - Stage 15/16
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-14.outputs.finished != 'true' }}
    needs: linux-x64-build-14
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: x64
      stage: 15
      from_artifact: true
      finished: ${{ needs.linux-x64-build-14.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-x64-build-16:
    name: Linux x64 - Stage 16/16 (Final)
    if: ${{ inputs.build_linux_x64 && needs.linux-x64-build-15.outputs.finished != 'true' }}
    needs: linux-x64-build-15
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: x64
      stage: 16
      from_artifact: true
      finished: ${{ needs.linux-x64-build-15.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  # ============================================================================
  # Windows x64 Build Chain (16 stages)
  # ============================================================================
  
  windows-x64-build-1:
    name: Windows x64 - Stage 1/16
    needs: validate-config
    if: ${{ inputs.build_windows_x64 }}
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x64
      stage: 1
      from_artifact: false
      finished: 'false'
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-2:
    name: Windows x64 - Stage 2/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-1.outputs.finished != 'true' }}
    needs: windows-x64-build-1
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x64
      stage: 2
      from_artifact: true
      finished: ${{ needs.windows-x64-build-1.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-3:
    name: Windows x64 - Stage 3/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-2.outputs.finished != 'true' }}
    needs: windows-x64-build-2
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x64
      stage: 3
      from_artifact: true
      finished: ${{ needs.windows-x64-build-2.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-4:
    name: Windows x64 - Stage 4/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-3.outputs.finished != 'true' }}
    needs: windows-x64-build-3
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x64
      stage: 4
      from_artifact: true
      finished: ${{ needs.windows-x64-build-3.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-5:
    name: Windows x64 - Stage 5/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-4.outputs.finished != 'true' }}
    needs: windows-x64-build-4
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x64
      stage: 5
      from_artifact: true
      finished: ${{ needs.windows-x64-build-4.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-6:
    name: Windows x64 - Stage 6/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-5.outputs.finished != 'true' }}
    needs: windows-x64-build-5
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x64
      stage: 6
      from_artifact: true
      finished: ${{ needs.windows-x64-build-5.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-7:
    name: Windows x64 - Stage 7/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-6.outputs.finished != 'true' }}
    needs: windows-x64-build-6
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x64
      stage: 7
      from_artifact: true
      finished: ${{ needs.windows-x64-build-6.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-8:
    name: Windows x64 - Stage 8/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-7.outputs.finished != 'true' }}
    needs: windows-x64-build-7
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x64
      stage: 8
      from_artifact: true
      finished: ${{ needs.windows-x64-build-7.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-9:
    name: Windows x64 - Stage 9/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-8.outputs.finished != 'true' }}
    needs: windows-x64-build-8
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x64
      stage: 9
      from_artifact: true
      finished: ${{ needs.windows-x64-build-8.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-10:
    name: Windows x64 - Stage 10/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-9.outputs.finished != 'true' }}
    needs: windows-x64-build-9
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x64
      stage: 10
      from_artifact: true
      finished: ${{ needs.windows-x64-build-9.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-11:
    name: Windows x64 - Stage 11/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-10.outputs.finished != 'true' }}
    needs: windows-x64-build-10
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x64
      stage: 11
      from_artifact: true
      finished: ${{ needs.windows-x64-build-10.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-12:
    name: Windows x64 - Stage 12/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-11.outputs.finished != 'true' }}
    needs: windows-x64-build-11
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x64
      stage: 12
      from_artifact: true
      finished: ${{ needs.windows-x64-build-11.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-13:
    name: Windows x64 - Stage 13/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-12.outputs.finished != 'true' }}
    needs: windows-x64-build-12
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x64
      stage: 13
      from_artifact: true
      finished: ${{ needs.windows-x64-build-12.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-14:
    name: Windows x64 - Stage 14/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-13.outputs.finished != 'true' }}
    needs: windows-x64-build-13
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x64
      stage: 14
      from_artifact: true
      finished: ${{ needs.windows-x64-build-13.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-15:
    name: Windows x64 - Stage 15/16
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-14.outputs.finished != 'true' }}
    needs: windows-x64-build-14
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x64
      stage: 15
      from_artifact: true
      finished: ${{ needs.windows-x64-build-14.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x64-build-16:
    name: Windows x64 - Stage 16/16 (Final)
    if: ${{ inputs.build_windows_x64 && needs.windows-x64-build-15.outputs.finished != 'true' }}
    needs: windows-x64-build-15
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x64
      stage: 16
      from_artifact: true
      finished: ${{ needs.windows-x64-build-15.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  # ============================================================================
  # Windows arm64 Build Chain (16 stages) - NEW!
  # ============================================================================
  
  windows-arm64-build-1:
    name: Windows arm64 - Stage 1/16
    needs: validate-config
    if: ${{ inputs.build_windows_arm64 }}
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: arm64
      stage: 1
      from_artifact: false
      finished: 'false'
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-2:
    name: Windows arm64 - Stage 2/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-1.outputs.finished != 'true' }}
    needs: windows-arm64-build-1
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: arm64
      stage: 2
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-1.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-3:
    name: Windows arm64 - Stage 3/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-2.outputs.finished != 'true' }}
    needs: windows-arm64-build-2
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: arm64
      stage: 3
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-2.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-4:
    name: Windows arm64 - Stage 4/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-3.outputs.finished != 'true' }}
    needs: windows-arm64-build-3
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: arm64
      stage: 4
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-3.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-5:
    name: Windows arm64 - Stage 5/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-4.outputs.finished != 'true' }}
    needs: windows-arm64-build-4
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: arm64
      stage: 5
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-4.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-6:
    name: Windows arm64 - Stage 6/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-5.outputs.finished != 'true' }}
    needs: windows-arm64-build-5
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: arm64
      stage: 6
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-5.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-7:
    name: Windows arm64 - Stage 7/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-6.outputs.finished != 'true' }}
    needs: windows-arm64-build-6
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: arm64
      stage: 7
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-6.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-8:
    name: Windows arm64 - Stage 8/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-7.outputs.finished != 'true' }}
    needs: windows-arm64-build-7
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: arm64
      stage: 8
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-7.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-9:
    name: Windows arm64 - Stage 9/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-8.outputs.finished != 'true' }}
    needs: windows-arm64-build-8
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: arm64
      stage: 9
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-8.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-10:
    name: Windows arm64 - Stage 10/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-9.outputs.finished != 'true' }}
    needs: windows-arm64-build-9
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: arm64
      stage: 10
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-9.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-11:
    name: Windows arm64 - Stage 11/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-10.outputs.finished != 'true' }}
    needs: windows-arm64-build-10
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: arm64
      stage: 11
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-10.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-12:
    name: Windows arm64 - Stage 12/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-11.outputs.finished != 'true' }}
    needs: windows-arm64-build-11
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: arm64
      stage: 12
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-11.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-13:
    name: Windows arm64 - Stage 13/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-12.outputs.finished != 'true' }}
    needs: windows-arm64-build-12
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: arm64
      stage: 13
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-12.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-14:
    name: Windows arm64 - Stage 14/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-13.outputs.finished != 'true' }}
    needs: windows-arm64-build-13
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: arm64
      stage: 14
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-13.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-15:
    name: Windows arm64 - Stage 15/16
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-14.outputs.finished != 'true' }}
    needs: windows-arm64-build-14
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: arm64
      stage: 15
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-14.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-arm64-build-16:
    name: Windows arm64 - Stage 16/16 (Final)
    if: ${{ inputs.build_windows_arm64 && needs.windows-arm64-build-15.outputs.finished != 'true' }}
    needs: windows-arm64-build-15
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: arm64
      stage: 16
      from_artifact: true
      finished: ${{ needs.windows-arm64-build-15.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  # ============================================================================
  # Windows x86 Build Chain (16 stages) - Optional
  # ============================================================================
  
  windows-x86-build-1:
    name: Windows x86 - Stage 1/16
    needs: validate-config
    if: ${{ inputs.build_windows_x86 }}
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x86
      stage: 1
      from_artifact: false
      finished: 'false'
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-2:
    name: Windows x86 - Stage 2/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-1.outputs.finished != 'true' }}
    needs: windows-x86-build-1
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x86
      stage: 2
      from_artifact: true
      finished: ${{ needs.windows-x86-build-1.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-3:
    name: Windows x86 - Stage 3/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-2.outputs.finished != 'true' }}
    needs: windows-x86-build-2
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x86
      stage: 3
      from_artifact: true
      finished: ${{ needs.windows-x86-build-2.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-4:
    name: Windows x86 - Stage 4/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-3.outputs.finished != 'true' }}
    needs: windows-x86-build-3
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x86
      stage: 4
      from_artifact: true
      finished: ${{ needs.windows-x86-build-3.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-5:
    name: Windows x86 - Stage 5/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-4.outputs.finished != 'true' }}
    needs: windows-x86-build-4
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x86
      stage: 5
      from_artifact: true
      finished: ${{ needs.windows-x86-build-4.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-6:
    name: Windows x86 - Stage 6/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-5.outputs.finished != 'true' }}
    needs: windows-x86-build-5
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x86
      stage: 6
      from_artifact: true
      finished: ${{ needs.windows-x86-build-5.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-7:
    name: Windows x86 - Stage 7/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-6.outputs.finished != 'true' }}
    needs: windows-x86-build-6
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x86
      stage: 7
      from_artifact: true
      finished: ${{ needs.windows-x86-build-6.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-8:
    name: Windows x86 - Stage 8/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-7.outputs.finished != 'true' }}
    needs: windows-x86-build-7
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x86
      stage: 8
      from_artifact: true
      finished: ${{ needs.windows-x86-build-7.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-9:
    name: Windows x86 - Stage 9/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-8.outputs.finished != 'true' }}
    needs: windows-x86-build-8
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x86
      stage: 9
      from_artifact: true
      finished: ${{ needs.windows-x86-build-8.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-10:
    name: Windows x86 - Stage 10/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-9.outputs.finished != 'true' }}
    needs: windows-x86-build-9
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x86
      stage: 10
      from_artifact: true
      finished: ${{ needs.windows-x86-build-9.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-11:
    name: Windows x86 - Stage 11/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-10.outputs.finished != 'true' }}
    needs: windows-x86-build-10
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x86
      stage: 11
      from_artifact: true
      finished: ${{ needs.windows-x86-build-10.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-12:
    name: Windows x86 - Stage 12/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-11.outputs.finished != 'true' }}
    needs: windows-x86-build-11
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x86
      stage: 12
      from_artifact: true
      finished: ${{ needs.windows-x86-build-11.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-13:
    name: Windows x86 - Stage 13/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-12.outputs.finished != 'true' }}
    needs: windows-x86-build-12
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x86
      stage: 13
      from_artifact: true
      finished: ${{ needs.windows-x86-build-12.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-14:
    name: Windows x86 - Stage 14/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-13.outputs.finished != 'true' }}
    needs: windows-x86-build-13
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x86
      stage: 14
      from_artifact: true
      finished: ${{ needs.windows-x86-build-13.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-15:
    name: Windows x86 - Stage 15/16
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-14.outputs.finished != 'true' }}
    needs: windows-x86-build-14
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x86
      stage: 15
      from_artifact: true
      finished: ${{ needs.windows-x86-build-14.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  windows-x86-build-16:
    name: Windows x86 - Stage 16/16 (Final)
    if: ${{ inputs.build_windows_x86 && needs.windows-x86-build-15.outputs.finished != 'true' }}
    needs: windows-x86-build-15
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: windows
      arch: x86
      stage: 16
      from_artifact: true
      finished: ${{ needs.windows-x86-build-15.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  # ============================================================================
  # macOS x64 Build Chain (16 stages)
  # ============================================================================
  
  macos-x64-build-1:
    name: macOS x64 - Stage 1/16
    needs: validate-config
    if: ${{ inputs.build_macos_x64 }}
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: x64
      stage: 1
      from_artifact: false
      finished: 'false'
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-2:
    name: macOS x64 - Stage 2/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-1.outputs.finished != 'true' }}
    needs: macos-x64-build-1
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: x64
      stage: 2
      from_artifact: true
      finished: ${{ needs.macos-x64-build-1.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-3:
    name: macOS x64 - Stage 3/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-2.outputs.finished != 'true' }}
    needs: macos-x64-build-2
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: x64
      stage: 3
      from_artifact: true
      finished: ${{ needs.macos-x64-build-2.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-4:
    name: macOS x64 - Stage 4/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-3.outputs.finished != 'true' }}
    needs: macos-x64-build-3
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: x64
      stage: 4
      from_artifact: true
      finished: ${{ needs.macos-x64-build-3.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-5:
    name: macOS x64 - Stage 5/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-4.outputs.finished != 'true' }}
    needs: macos-x64-build-4
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: x64
      stage: 5
      from_artifact: true
      finished: ${{ needs.macos-x64-build-4.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-6:
    name: macOS x64 - Stage 6/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-5.outputs.finished != 'true' }}
    needs: macos-x64-build-5
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: x64
      stage: 6
      from_artifact: true
      finished: ${{ needs.macos-x64-build-5.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-7:
    name: macOS x64 - Stage 7/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-6.outputs.finished != 'true' }}
    needs: macos-x64-build-6
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: x64
      stage: 7
      from_artifact: true
      finished: ${{ needs.macos-x64-build-6.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-8:
    name: macOS x64 - Stage 8/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-7.outputs.finished != 'true' }}
    needs: macos-x64-build-7
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: x64
      stage: 8
      from_artifact: true
      finished: ${{ needs.macos-x64-build-7.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-9:
    name: macOS x64 - Stage 9/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-8.outputs.finished != 'true' }}
    needs: macos-x64-build-8
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: x64
      stage: 9
      from_artifact: true
      finished: ${{ needs.macos-x64-build-8.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-10:
    name: macOS x64 - Stage 10/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-9.outputs.finished != 'true' }}
    needs: macos-x64-build-9
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: x64
      stage: 10
      from_artifact: true
      finished: ${{ needs.macos-x64-build-9.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-11:
    name: macOS x64 - Stage 11/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-10.outputs.finished != 'true' }}
    needs: macos-x64-build-10
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: x64
      stage: 11
      from_artifact: true
      finished: ${{ needs.macos-x64-build-10.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-12:
    name: macOS x64 - Stage 12/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-11.outputs.finished != 'true' }}
    needs: macos-x64-build-11
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: x64
      stage: 12
      from_artifact: true
      finished: ${{ needs.macos-x64-build-11.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-13:
    name: macOS x64 - Stage 13/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-12.outputs.finished != 'true' }}
    needs: macos-x64-build-12
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: x64
      stage: 13
      from_artifact: true
      finished: ${{ needs.macos-x64-build-12.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-14:
    name: macOS x64 - Stage 14/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-13.outputs.finished != 'true' }}
    needs: macos-x64-build-13
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: x64
      stage: 14
      from_artifact: true
      finished: ${{ needs.macos-x64-build-13.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-15:
    name: macOS x64 - Stage 15/16
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-14.outputs.finished != 'true' }}
    needs: macos-x64-build-14
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: x64
      stage: 15
      from_artifact: true
      finished: ${{ needs.macos-x64-build-14.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-x64-build-16:
    name: macOS x64 - Stage 16/16 (Final)
    if: ${{ inputs.build_macos_x64 && needs.macos-x64-build-15.outputs.finished != 'true' }}
    needs: macos-x64-build-15
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: x64
      stage: 16
      from_artifact: true
      finished: ${{ needs.macos-x64-build-15.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  # ============================================================================
  # macOS arm64 Build Chain (16 stages)
  # ============================================================================
  
  macos-arm64-build-1:
    name: macOS arm64 - Stage 1/16
    needs: validate-config
    if: ${{ inputs.build_macos_arm64 }}
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: arm64
      stage: 1
      from_artifact: false
      finished: 'false'
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-2:
    name: macOS arm64 - Stage 2/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-1.outputs.finished != 'true' }}
    needs: macos-arm64-build-1
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: arm64
      stage: 2
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-1.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-3:
    name: macOS arm64 - Stage 3/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-2.outputs.finished != 'true' }}
    needs: macos-arm64-build-2
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: arm64
      stage: 3
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-2.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-4:
    name: macOS arm64 - Stage 4/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-3.outputs.finished != 'true' }}
    needs: macos-arm64-build-3
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: arm64
      stage: 4
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-3.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-5:
    name: macOS arm64 - Stage 5/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-4.outputs.finished != 'true' }}
    needs: macos-arm64-build-4
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: arm64
      stage: 5
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-4.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-6:
    name: macOS arm64 - Stage 6/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-5.outputs.finished != 'true' }}
    needs: macos-arm64-build-5
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: arm64
      stage: 6
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-5.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-7:
    name: macOS arm64 - Stage 7/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-6.outputs.finished != 'true' }}
    needs: macos-arm64-build-6
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: arm64
      stage: 7
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-6.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-8:
    name: macOS arm64 - Stage 8/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-7.outputs.finished != 'true' }}
    needs: macos-arm64-build-7
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: arm64
      stage: 8
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-7.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-9:
    name: macOS arm64 - Stage 9/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-8.outputs.finished != 'true' }}
    needs: macos-arm64-build-8
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: arm64
      stage: 9
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-8.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-10:
    name: macOS arm64 - Stage 10/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-9.outputs.finished != 'true' }}
    needs: macos-arm64-build-9
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: arm64
      stage: 10
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-9.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-11:
    name: macOS arm64 - Stage 11/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-10.outputs.finished != 'true' }}
    needs: macos-arm64-build-10
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: arm64
      stage: 11
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-10.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-12:
    name: macOS arm64 - Stage 12/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-11.outputs.finished != 'true' }}
    needs: macos-arm64-build-11
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: arm64
      stage: 12
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-11.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-13:
    name: macOS arm64 - Stage 13/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-12.outputs.finished != 'true' }}
    needs: macos-arm64-build-12
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: arm64
      stage: 13
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-12.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-14:
    name: macOS arm64 - Stage 14/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-13.outputs.finished != 'true' }}
    needs: macos-arm64-build-13
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: arm64
      stage: 14
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-13.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-15:
    name: macOS arm64 - Stage 15/16
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-14.outputs.finished != 'true' }}
    needs: macos-arm64-build-14
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: arm64
      stage: 15
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-14.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  macos-arm64-build-16:
    name: macOS arm64 - Stage 16/16 (Final)
    if: ${{ inputs.build_macos_arm64 && needs.macos-arm64-build-15.outputs.finished != 'true' }}
    needs: macos-arm64-build-15
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: macos
      arch: arm64
      stage: 16
      from_artifact: true
      finished: ${{ needs.macos-arm64-build-15.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  # ============================================================================
  # Linux arm64 Build Chain (16 stages)
  # ============================================================================
  
  linux-arm64-build-1:
    name: Linux arm64 - Stage 1/16
    needs: validate-config
    if: ${{ inputs.build_linux_arm64 }}
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: arm64
      stage: 1
      from_artifact: false
      finished: 'false'
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-2:
    name: Linux arm64 - Stage 2/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-1.outputs.finished != 'true' }}
    needs: linux-arm64-build-1
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: arm64
      stage: 2
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-1.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-3:
    name: Linux arm64 - Stage 3/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-2.outputs.finished != 'true' }}
    needs: linux-arm64-build-2
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: arm64
      stage: 3
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-2.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-4:
    name: Linux arm64 - Stage 4/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-3.outputs.finished != 'true' }}
    needs: linux-arm64-build-3
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: arm64
      stage: 4
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-3.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-5:
    name: Linux arm64 - Stage 5/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-4.outputs.finished != 'true' }}
    needs: linux-arm64-build-4
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: arm64
      stage: 5
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-4.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-6:
    name: Linux arm64 - Stage 6/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-5.outputs.finished != 'true' }}
    needs: linux-arm64-build-5
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: arm64
      stage: 6
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-5.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-7:
    name: Linux arm64 - Stage 7/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-6.outputs.finished != 'true' }}
    needs: linux-arm64-build-6
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: arm64
      stage: 7
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-6.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-8:
    name: Linux arm64 - Stage 8/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-7.outputs.finished != 'true' }}
    needs: linux-arm64-build-7
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: arm64
      stage: 8
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-7.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-9:
    name: Linux arm64 - Stage 9/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-8.outputs.finished != 'true' }}
    needs: linux-arm64-build-8
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: arm64
      stage: 9
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-8.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-10:
    name: Linux arm64 - Stage 10/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-9.outputs.finished != 'true'  }}
    needs: linux-arm64-build-9
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: arm64
      stage: 10
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-9.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-11:
    name: Linux arm64 - Stage 11/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-10.outputs.finished != 'true' }}
    needs: linux-arm64-build-10
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: arm64
      stage: 11
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-10.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-12:
    name: Linux arm64 - Stage 12/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-11.outputs.finished != 'true' }}
    needs: linux-arm64-build-11
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: arm64
      stage: 12
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-11.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-13:
    name: Linux arm64 - Stage 13/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-12.outputs.finished != 'true' }}
    needs: linux-arm64-build-12
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: arm64
      stage: 13
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-12.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-14:
    name: Linux arm64 - Stage 14/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-13.outputs.finished != 'true' }}
    needs: linux-arm64-build-13
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: arm64
      stage: 14
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-13.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-15:
    name: Linux arm64 - Stage 15/16
    if: ${{ inputs.build_linux_arm64 && needs.linux-arm64-build-14.outputs.finished != 'true' }}
    needs: linux-arm64-build-14
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: arm64
      stage: 15
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-14.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  linux-arm64-build-16:
    name: Linux arm64 - Stage 16/16 (Final)
    if: ${{ inputs.build_linux_arm64  && needs.linux-arm64-build-15.outputs.finished != 'true' }}
    needs: linux-arm64-build-15
    uses: ./.github/workflows/builder.yml
    with:
      environment: ${{ inputs.environment }}
      platform: linux
      arch: arm64
      stage: 16
      from_artifact: true
      finished: ${{ needs.linux-arm64-build-15.outputs.finished }}
      build_type: Release
      run_id: ${{ github.run_id }}
    secrets:
      PRIVATE_REPO_PAT: ${{ secrets.PRIVATE_REPO_PAT }}
      BRAVE_ENV_CONFIG: ${{ secrets.BRAVE_ENV_CONFIG }}
      ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
      LOG_PASSWORD: ${{ secrets.LOG_PASSWORD }}

  # ============================================================================
  # Collect All Artifacts - Waits for ALL selected builds to complete
  # ============================================================================
  
  collect-artifacts:
    name: Collect All Build Artifacts
    needs: [
      linux-x64-build-16,
      linux-arm64-build-16,
      macos-x64-build-16,
      macos-arm64-build-16,
      windows-x64-build-16,
      windows-arm64-build-16,
      windows-x86-build-16
    ]
    if: always()
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Download Linux x64 artifact
        if: ${{ inputs.build_linux_x64 }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: brave-browser-linux
          path: ./artifacts/linux-x64
      
      - name: Download Linux arm64 artifact
        if: ${{ inputs.build_linux_arm64 }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: brave-browser-linux-arm64
          path: ./artifacts/linux-arm64
      
      - name: Download macOS x64 artifact
        if: ${{ inputs.build_macos_x64 }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: brave-browser-macos
          path: ./artifacts/macos-x64
      
      - name: Download macOS arm64 artifact
        if: ${{ inputs.build_macos_arm64 }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: brave-browser-macos-arm64
          path: ./artifacts/macos-arm64
      
      - name: Download Windows x64 artifact
        if: ${{ inputs.build_windows_x64 }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: brave-browser-windows
          path: ./artifacts/windows-x64
      
      - name: Download Windows arm64 artifact
        if: ${{ inputs.build_windows_arm64 }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: brave-browser-windows-arm64
          path: ./artifacts/windows-arm64
      
      - name: Download Windows x86 artifact
        if: ${{ inputs.build_windows_x86 }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: brave-browser-windows-x86
          path: ./artifacts/windows-x86
      
      - name: List all artifacts
        run: |
          echo "=== All Build Artifacts ==="
          if [ -d ./artifacts ]; then
            find ./artifacts -type f -exec ls -lh {} \;
          else
            echo "No artifacts directory found"
          fi
          echo ""
          echo "‚úì All selected builds completed!"
          if [ "${{ inputs.publish_release }}" == "true" ] && [ "${{ vars.ALLOW_PUBLISH_RELEASE }}" == "true" ]; then
            echo "‚úì Ready for release publishing"
          else
            echo "‚ÑπÔ∏è  Test build - artifacts available in workflow run"
            echo "‚ÑπÔ∏è  Release publishing is disabled (requires publish_release=true and ALLOW_PUBLISH_RELEASE variable=true)"
          fi
      
      - name: Verify encrypted artifacts
        run: |
          echo "=== Verifying Encrypted Artifacts ==="
          cd ./artifacts
          
          # List all encrypted files (checksums will be generated after decryption in publish-release)
          echo "Encrypted packages (GPG - Linux/macOS):"
          find . -type f -name "*.gpg" -exec ls -lh {} \; || echo "  (none)"
          
          echo ""
          echo "Encrypted packages (7z - Windows):"
          find . -type f -name "*.7z" -exec ls -lh {} \; || echo "  (none)"
          
          echo ""
          echo "Note: SHA256 checksums will be generated after decryption in publish-release job"
      
      
      - name: Upload combined artifacts for release
        uses: actions/upload-artifact@v4
        with:
          name: brave-browser-all-platforms
          path: ./artifacts/
          retention-days: 7

  # ============================================================================
  # Publish Release - Optional, With Optional Manual Approval
  # ============================================================================
  
  publish-release:
    name: üì¶ Publish Release
    if: ${{ inputs.publish_release && vars.ALLOW_PUBLISH_RELEASE == 'true' }}
    needs: collect-artifacts
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Download all platform artifacts
        uses: actions/download-artifact@v4
        with:
          name: brave-browser-all-platforms
          path: ./release
      
      - name: Display encrypted contents
        run: |
          echo "=== Downloaded Encrypted Artifacts ==="
          find ./release -type f -exec ls -lh {} \;
          echo ""
      
      - name: Decrypt artifacts (GPG - Linux/macOS)
        env:
          ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
        run: |
          echo "=== Decrypting GPG-encrypted artifacts ==="
          
          if [ -z "$ARCHIVE_PASSWORD" ]; then
            echo "‚ö†Ô∏è  ARCHIVE_PASSWORD not set - checking for unencrypted files"
          else
            echo "‚úì ARCHIVE_PASSWORD is set"
          fi
          
          # Find and decrypt all .gpg files (Linux/macOS packages)
          find ./release -name "*.gpg" | while read -r gpg_file; do
            echo "Decrypting: $gpg_file"
            output_file="${gpg_file%.gpg}"
            
            echo "$ARCHIVE_PASSWORD" | gpg --batch --yes --passphrase-fd 0 --decrypt --output "$output_file" "$gpg_file"
            
            if [ $? -eq 0 ]; then
              echo "‚úì Decrypted to: $output_file"
              rm "$gpg_file"
            else
              echo "‚úó Failed to decrypt: $gpg_file"
              exit 1
            fi
          done
          
          echo "‚úì GPG decryption complete"
      
      - name: Decrypt artifacts (7z - Windows)
        env:
          ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
        run: |
          echo "=== Decrypting 7z-encrypted artifacts ==="
          
          # Install p7zip for extracting 7z files
          sudo apt-get update && sudo apt-get install -y p7zip-full
          
          # Find and decrypt all .7z files (Windows packages)
          find ./release -name "*.7z" | while read -r sevenzip_file; do
            echo "Decrypting: $sevenzip_file"
            output_dir=$(dirname "$sevenzip_file")
            
            7z x "$sevenzip_file" -o"$output_dir" -p"$ARCHIVE_PASSWORD" -y
            
            if [ $? -eq 0 ]; then
              echo "‚úì Extracted to: $output_dir"
              rm "$sevenzip_file"
            else
              echo "‚úó Failed to decrypt: $sevenzip_file"
              exit 1
            fi
          done
          
          echo "‚úì 7z decryption complete"
      
      - name: Display decrypted release contents
        run: |
          echo "=== Decrypted Release Contents ==="
          find ./release -type f -exec ls -lh {} \;
          echo ""
      
      - name: Generate checksums for release
        run: |
          echo "=== Generating SHA256 checksums ==="
          cd ./release
          
          # Generate SHA256 for all release archives (.zip files)
          find . -type f -name "*.zip" | while read -r file; do
            echo "Generating checksum for: $file"
            checksum=$(sha256sum "$file" | sed 's|./||')
            echo "$checksum" > "$file.sha256"
            echo "Created: $file.sha256"
            echo "SHA256: $checksum"
          done
          
          echo ""
          echo "=== Checksum Summary ==="
          find . -name "*.sha256" | while read -r checksum_file; do
            artifact_file="${checksum_file%.sha256}"
            checksum=$(cat "$checksum_file")
            filename=$(basename "$artifact_file")
            echo "$checksum  $filename"
          done
          
          echo ""
          echo "Publishing to GitHub Releases..."
      
      - name: Generate build summary
        id: summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # üéâ Brave Browser Build Complete (16-Stage)
          
          ## üì¶ Build Configuration
          
          | Platform | Status | Build Type |
          |----------|--------|------------|
          | üêß Linux x64 | ${{ inputs.build_linux_x64 && '‚úÖ Built' || '‚è≠Ô∏è Skipped' }} | ${{ inputs.build_type }} |
          | üêß Linux arm64 | ${{ inputs.build_linux_arm64 && '‚úÖ Built' || '‚è≠Ô∏è Skipped' }} | ${{ inputs.build_type }} |
          | üçé macOS x64 | ${{ inputs.build_macos_x64 && '‚úÖ Built' || '‚è≠Ô∏è Skipped' }} | ${{ inputs.build_type }} |
          | üçé macOS arm64 | ${{ inputs.build_macos_arm64 && '‚úÖ Built' || '‚è≠Ô∏è Skipped' }} | ${{ inputs.build_type }} |
          | ü™ü Windows x64 | ${{ inputs.build_windows_x64 && '‚úÖ Built' || '‚è≠Ô∏è Skipped' }} | ${{ inputs.build_type }} |
          | ü™ü Windows arm64 | ${{ inputs.build_windows_arm64 && '‚úÖ Built' || '‚è≠Ô∏è Skipped' }} | ${{ inputs.build_type }} |
          | ü™ü Windows x86 | ${{ inputs.build_windows_x86 && '‚úÖ Built' || '‚è≠Ô∏è Skipped' }} | ${{ inputs.build_type }} |
            
          ## üîê Security & Verification
          
          - **Checksums**: SHA256 generated for all artifacts
          - **Release Type**: Pre-release (custom rebuild)
          
          ## üìä Release Status
          
          - **Publishing**: ${{ inputs.publish_release && '‚úÖ Requested' || '‚ùå Disabled' }} (ALLOW_PUBLISH_RELEASE variable controls actual publishing)
          - **Environment**: ${{ inputs.environment && inputs.environment || '‚è≠Ô∏è None selected' }}
          - **Workflow Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          
          **Build triggered by:** @${{ github.actor }} | **Commit:** `${{ github.sha }}`
          EOF
          
          PLATFORMS=""
          ${{ inputs.build_linux_x64 }} && PLATFORMS="${PLATFORMS}- Linux x64\n"
          ${{ inputs.build_linux_arm64 }} && PLATFORMS="${PLATFORMS}- Linux arm64\n"
          ${{ inputs.build_macos_x64 }} && PLATFORMS="${PLATFORMS}- macOS x64\n"
          ${{ inputs.build_macos_arm64 }} && PLATFORMS="${PLATFORMS}- macOS arm64\n"
          ${{ inputs.build_windows_x64 }} && PLATFORMS="${PLATFORMS}- Windows x64\n"
          ${{ inputs.build_windows_arm64 }} && PLATFORMS="${PLATFORMS}- Windows arm64\n"
          ${{ inputs.build_windows_x86 }} && PLATFORMS="${PLATFORMS}- Windows x86\n"
          echo "platforms<<EOF" >> $GITHUB_OUTPUT
          echo -e "$PLATFORMS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}-${{ github.sha }}
          name: Brave Browser Build ${{ github.run_number }} (16-Stage)
          body: |
            ## Brave Browser - Multi-Platform Build (16-Stage Reliability)
            
            **Build**: #${{ github.run_number }}
            **Commit**: ${{ github.sha }}
            **Triggered by**: @${{ github.actor }}
            **Date**: ${{ github.event.repository.updated_at }}
            **Stages per platform**: 16 (for maximum reliability)
            
            ### Platforms Included:
            ${{ steps.summary.outputs.platforms }}
            
            ### Installation
            Download the appropriate package for your platform and extract it.
            
            ### Build Details
            - **16 stages per platform** for maximum reliability
            - Each stage runs for ~18-20 minutes
            - Better checkpoint granularity reduces risk of failures
            
            **Note:** This is a custom rebuild with symbol stripping for size/speed optimization.
          draft: false
          prerelease: true
          fail_on_unmatched_files: true
          files: |
            ./release/**/*.zip
            ./release/**/*.sha256
      
      - name: Release published
        run: |
          echo "‚úì Release published successfully!"
          echo "Check: https://github.com/${{ github.repository }}/releases"
