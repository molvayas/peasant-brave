name: Publish Release (from existing artifact)

# Temporary workflow ‚Äî publishes a release from an artifact that was
# already uploaded by a previous build-16stage run.
#
# Usage:
#   1. Go to Actions ‚Üí "Publish Release (from existing artifact)"
#   2. Enter the run_id of the build that produced the artifact
#   3. Optionally select the 'release' environment for approval gates
#   4. Click "Run workflow"
#
# Delete this file once you've confirmed it works.

on:
  workflow_dispatch:
    inputs:
      source_run_id:
        description: 'Run ID of the build workflow that uploaded brave-browser-all-platforms (e.g. 21829087464)'
        required: true
        type: string
      environment:
        description: 'Deployment environment (select "release" for approval gate)'
        required: false
        type: environment

jobs:
  publish-release:
    name: üì¶ Publish Release
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Download artifact from source run
        uses: actions/download-artifact@v4
        with:
          name: brave-browser-all-platforms
          path: ./release
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ inputs.source_run_id }}

      - name: Display encrypted contents
        run: |
          echo "=== Downloaded Encrypted Artifacts ==="
          echo "Source run: ${{ inputs.source_run_id }}"
          echo ""
          find ./release -type f -exec ls -lh {} \;
          echo ""

      - name: Decrypt artifacts (GPG - Linux/macOS)
        env:
          ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
        run: |
          echo "=== Decrypting GPG-encrypted artifacts ==="

          if [ -z "$ARCHIVE_PASSWORD" ]; then
            echo "‚ö†Ô∏è  ARCHIVE_PASSWORD not set - checking for unencrypted files"
          else
            echo "‚úì ARCHIVE_PASSWORD is set"
          fi

          # Find and decrypt all .gpg files (Linux/macOS packages)
          find ./release -name "*.gpg" | while read -r gpg_file; do
            echo "Decrypting: $gpg_file"
            output_file="${gpg_file%.gpg}"

            echo "$ARCHIVE_PASSWORD" | gpg --batch --yes --passphrase-fd 0 --decrypt --output "$output_file" "$gpg_file"

            if [ $? -eq 0 ]; then
              echo "‚úì Decrypted to: $output_file"
              rm "$gpg_file"
            else
              echo "‚úó Failed to decrypt: $gpg_file"
              exit 1
            fi
          done

          echo "‚úì GPG decryption complete"

      - name: Decrypt artifacts (7z - Windows)
        env:
          ARCHIVE_PASSWORD: ${{ secrets.ARCHIVE_PASSWORD }}
        run: |
          echo "=== Decrypting 7z-encrypted artifacts ==="

          # Install p7zip for extracting 7z files
          sudo apt-get update && sudo apt-get install -y p7zip-full

          # Find and decrypt all .7z files (Windows packages)
          find ./release -name "*.7z" | while read -r sevenzip_file; do
            echo "Decrypting: $sevenzip_file"
            output_dir=$(dirname "$sevenzip_file")

            7z x "$sevenzip_file" -o"$output_dir" -p"$ARCHIVE_PASSWORD" -y

            if [ $? -eq 0 ]; then
              echo "‚úì Extracted to: $output_dir"
              rm "$sevenzip_file"
            else
              echo "‚úó Failed to decrypt: $sevenzip_file"
              exit 1
            fi
          done

          echo "‚úì 7z decryption complete"

      - name: Display decrypted release contents
        run: |
          echo "=== Decrypted Release Contents ==="
          find ./release -type f -exec ls -lh {} \;
          echo ""

      - name: Encrypt release artifacts (AES-256-GCM)
        run: |
          echo "=== Encrypting release artifacts with AES-256-GCM ==="

          # This key is INTENTIONALLY PUBLIC. Its only purpose is to prevent
          # non-technical users from accidentally downloading and running the
          # browser outside the launcher. If you need the key, here it is.
          # Use the launcher instead: https://browser.omeglelike.com
          #
          # openssl enc does NOT support AEAD ciphers, so we use Python's
          # cryptography library which is pre-installed on GitHub runners.

          python3 - ./release <<'PYEOF'
          import sys, os, glob
          from cryptography.hazmat.primitives.ciphers.aead import AESGCM

          KEY = bytes.fromhex("8488feb81de4054780571ccacf709a33074b23665b64ec7114301c60ab102b15")
          release_dir = sys.argv[1]

          zip_files = glob.glob(os.path.join(release_dir, "**", "*.zip"), recursive=True)
          if not zip_files:
              print("‚ö†Ô∏è  No .zip files found to encrypt")
              sys.exit(0)

          aesgcm = AESGCM(KEY)

          for zip_path in zip_files:
              print(f"Encrypting: {zip_path}")

              with open(zip_path, "rb") as f:
                  plaintext = f.read()

              orig_size = len(plaintext)

              # 12-byte random nonce
              nonce = os.urandom(12)

              # AES-256-GCM encrypt (returns ciphertext + 16-byte auth tag)
              ciphertext_and_tag = aesgcm.encrypt(nonce, plaintext, None)

              # Output format: [12-byte nonce][ciphertext + 16-byte GCM tag]
              enc_path = zip_path.rsplit(".zip", 1)[0] + ".enc"
              with open(enc_path, "wb") as f:
                  f.write(nonce)
                  f.write(ciphertext_and_tag)

              enc_size = os.path.getsize(enc_path)
              print(f"‚úì Encrypted: {zip_path} ({orig_size} bytes) -> {enc_path} ({enc_size} bytes)")

              os.remove(zip_path)

          print("‚úì AES-256-GCM encryption complete")
          PYEOF

      - name: Determine release tag
        id: tag
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Detect Brave version from artifact filenames (e.g. raven-v1.86.146-linux-x64.enc)
          VERSION=$(find ./release -type f -name "*.enc" -o -name "*.zip" | head -1 | sed -E 's/.*raven-(v[0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          
          if [ -z "$VERSION" ] || [[ ! "$VERSION" =~ ^v[0-9] ]]; then
            echo "Could not detect version from artifacts, falling back to run number"
            VERSION="v0.0.0-run${{ github.run_number }}"
          fi
          
          echo "Detected version: $VERSION"
          TAG="$VERSION"
          
          # Check existing releases; append -2, -3, etc. if tag exists
          EXISTING=$(gh release list --limit 100 --json tagName -q '.[].tagName' 2>/dev/null || true)
          
          if ! echo "$EXISTING" | grep -qx "$TAG"; then
            echo "tag=$TAG" >> $GITHUB_OUTPUT
          else
            SEQ=2
            while echo "$EXISTING" | grep -qx "${TAG}-${SEQ}"; do
              SEQ=$((SEQ + 1))
            done
            TAG="${TAG}-${SEQ}"
            echo "tag=$TAG" >> $GITHUB_OUTPUT
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using tag: $TAG"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.tag }}
          body: |
            **Brave**: `${{ steps.tag.outputs.version }}`
            **Commit**: `${{ github.sha }}`
            **Source build run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ inputs.source_run_id }}
            **Publish run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ---
            
            Artifacts are AES-256-GCM encrypted. Use the [launcher](https://browser.omeglelike.com) to download and run the browser. The launcher keeps it up to date securely and applies the necessary flags on launch. Advanced users can find the decryption key in the launcher/workflow source; non-technical users will benefit from sticking with the launcher.
            
            This is not a general-purpose web browser ‚Äî for everyday browsing, use [Brave](https://brave.com).
          draft: true
          prerelease: true
          files: |
            ./release/**/*.enc
      
      - name: Release created
        run: |
          echo "‚úì Draft release created: ${{ steps.tag.outputs.tag }}"
          echo "Source build run: ${{ inputs.source_run_id }}"
          echo "Review and publish at: https://github.com/${{ github.repository }}/releases"
